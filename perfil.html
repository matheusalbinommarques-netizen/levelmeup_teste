<!DOCTYPE html>
<html lang="pt-BR" dir="ltr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Perfil — Level Me Up!</title>
  <meta name="description" content="Veja estatísticas, conquistas e personalize seu perfil no Level Me Up!" />

  <!-- Favicon neutro -->
  <link rel="icon" href="data:,">
  <link rel="shortcut icon" href="data:,">

  <!-- Theme color -->
  <meta name="theme-color" content="#0b3042" media="(prefers-color-scheme: light)">
  <meta name="theme-color" content="#0b2533" media="(prefers-color-scheme: dark)">

  <!-- PWA -->
  <link rel="manifest" href="manifest.json" />

  <!-- CSP -->
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self';
                 script-src 'self' 'nonce-lmup-2025';
                 style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdnjs.cloudflare.com;
                 img-src 'self' data:;
                 font-src 'self' https://fonts.gstatic.com https://cdnjs.cloudflare.com;
                 connect-src 'self';
                 object-src 'none';
                 base-uri 'none';
                 worker-src 'self'">

  <!-- Fonts & Ícones -->
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
        crossorigin="anonymous"
        referrerpolicy="no-referrer" />

  <style>
    :root{
      color-scheme: light dark;
      --bg: #f7f8fa;
      --bg-dark: #14181b;
      --card: #ffffff;
      --card-dark: #1d2125;
      --border: #e5e7eb;
      --border-dark: #2f3338;
      --border-dark-contrast: #dde1e6;
      --text: #1f2933;
      --text-subtle: #52606d;
      --text-dark: #f5f7fa;
      --accent: #8b5cf6;
      --accent-soft: rgba(139, 92, 246, 0.12);
      --secondary: #f6c453;
      --focus: #8b5cf6;
      --radius: 12px;
      --shadow: 0 6px 24px rgba(15, 23, 42, 0.08);
      --shadow-dark: 0 10px 28px rgba(0, 0, 0, 0.35);
      --tap: 24px;
      --banner-gradient: linear-gradient(135deg, rgba(15, 76, 129, 0.82), rgba(139, 92, 246, 0.78));
    }
    *{ box-sizing: border-box; }
    body{
      margin:0;
      font-family:'Open Sans', system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height:1.5;
    }
    a{ color: inherit; }
    .sr-only{
      position:absolute!important;
      width:1px;
      height:1px;
      padding:0;
      margin:-1px;
      overflow:hidden;
      clip:rect(0,0,0,0);
      white-space:nowrap;
      border:0;
    }
    .skip-link{
      position:absolute;
      top:8px;
      left:8px;
      padding:8px 12px;
      background: var(--secondary);
      color:#111;
      border-radius:8px;
      transform: translateY(-200%);
      transition: transform .2s ease;
      z-index:1000;
      text-decoration:none;
      font-weight:600;
    }
    .skip-link:focus-visible{ transform: translateY(0); }
    :where(button,a,input,textarea,select){ min-width:var(--tap); min-height:var(--tap); }
    :where(button,a,input,textarea,select):focus-visible{ outline:3px solid var(--focus); outline-offset:2px; }
    @media (prefers-reduced-motion: reduce){ *{ animation:none!important; transition:none!important; } }

    main{ padding:32px 0 48px; }
    .wrap{ max-width:1180px; margin:0 auto; padding:0 16px; }
    .grid{ display:grid; grid-template-columns: minmax(0,2fr) minmax(260px,1fr); gap:20px; align-items:start; }
    .column{ display:flex; flex-direction:column; gap:20px; }
    .card{
      background: var(--card);
      border:1px solid var(--border);
      border-radius: var(--radius);
      padding:20px;
      box-shadow: var(--shadow);
    }
    .card h2{ margin:0 0 12px; font-size:20px; }

    .profile-hero{
      padding:0;
      overflow:hidden;
      position:relative;
    }
    .banner{
      position:relative;
      height:160px;
      background-image: var(--banner-gradient);
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      isolation:isolate;
      border:1px solid #000000;
    }
    .banner::before{
      content:"";
      position:absolute;
      inset:0;
      background: linear-gradient(180deg, rgba(8, 27, 38, 0.35), rgba(8, 27, 38, 0.55));
      pointer-events:none;
      mix-blend-mode: multiply;
      opacity:0;
      transition: opacity .24s ease;
    }
    .banner::after{
      content:"";
      position:absolute;
      inset:0;
      background-image:url('data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="200" height="200" viewBox="0 0 200 200" fill="none"%3E%3Cpath d="M0 160L80 80L160 200" stroke="rgba(255,255,255,0.15)" stroke-width="16"/%3E%3C/svg%3E');
      opacity:.6;
      pointer-events:none;
    }
    .banner[data-has-image="true"]{
      background-image: var(--banner-photo);
    }
    .banner[data-has-image="true"]::before{
      opacity:1;
    }
    .banner[data-has-image="true"]::after{
      content:none;
    }
    #bannerToast{
      position:absolute;
      right:16px;
      bottom:16px;
      padding:10px 14px;
      border-radius:12px;
      font-size:14px;
      font-weight:700;
      background:rgba(15,23,42,0.86);
      color:#f9fafb;
      border:1px solid rgba(15,23,42,0.4);
      box-shadow:0 10px 24px rgba(15,23,42,0.2);
      opacity:0;
      transform: translateY(6px);
      pointer-events:none;
      transition: opacity .24s ease, transform .24s ease;
      max-width:min(280px, calc(100% - 32px));
      backdrop-filter: blur(12px);
      z-index:2;
    }
    #bannerToast.is-visible{
      opacity:1;
      transform: translateY(0);
    }
    #bannerToast.is-success{
      background:linear-gradient(135deg, #0f766e, #14b8a6);
      border-color:rgba(15,118,110,0.7);
      color:#f0fdfa;
    }
    #bannerToast.is-error{
      background:linear-gradient(135deg, #b91c1c, #ef4444);
      border-color:rgba(185,28,28,0.7);
      color:#fff5f5;
    }
    .dark-mode #bannerToast{
      box-shadow:var(--shadow-dark);
      border-color:rgba(148,163,184,0.3);
    }
    .dark-mode #bannerToast.is-success{
      border-color:rgba(20,184,166,0.6);
    }
    .dark-mode #bannerToast.is-error{
      border-color:rgba(248,113,113,0.6);
    }
    .banner-btn{
      border:1px solid rgba(11,48,66,0.28);
      background:linear-gradient(135deg, rgba(255,255,255,0.97), rgba(221,232,255,0.9));
      color:#0b2533;
      padding:6px 14px;
      border-radius:999px;
      backdrop-filter: blur(8px);
      font-weight:600;
      text-shadow:0 1px 2px rgba(255,255,255,0.65);
      box-shadow:0 6px 16px rgba(15,23,42,0.15);
    }
    .banner-btn:hover,
    .banner-btn:focus-visible{
      background:linear-gradient(135deg, rgba(255,255,255,1), rgba(214,227,255,0.98));
      box-shadow:0 10px 22px rgba(15,23,42,0.22);
    }

    /* Linha do perfil centralizada e fluida */
    .profile-core{
      display:flex;
      align-items:center;
      gap:16px;
      padding:0 24px 24px;
      margin-top:0;
      flex-wrap:nowrap;
    }
    .avatar{
      width:108px;
      height:108px;
      border-radius:24px;
      background:#fff;
      display:grid;
      place-items:center;
      font-size:36px;
      font-weight:800;
      color:#0b3042;
      border:4px solid #fff;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .avatar img{ width:100%; height:100%; object-fit:cover; display:block; }
    .profile-info{ flex:1; min-width:0; display:flex; flex-direction:column; gap:8px; }
    .profile-name{ font-size:26px; font-weight:800; color: var(--text-strong); }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 14px;
      border-radius:999px;
      background:var(--accent-soft);
      color:var(--accent);
      font-weight:700;
      border:1px solid rgba(139,92,246,0.32);
      box-shadow:0 2px 6px rgba(15,23,42,0.08);
    }
    .profile-badges{ list-style:none; padding:0; margin:0; display:flex; flex-wrap:wrap; gap:12px; justify-content:flex-start; }
    .profile-badges li{ display:flex; align-items:center; gap:6px; }
    .profile-badges strong{ font-size:18px; }

    .stats-list{ list-style:none; padding:0; margin:0; display:grid; grid-template-columns:repeat(auto-fit,minmax(160px,1fr)); gap:12px; }
    .stats-list li{
      border:1px solid var(--border);
      border-radius:10px;
      padding:12px;
      background:rgba(139,92,246,0.05);
    }
    .stats-list h3{ margin:0 0 4px; font-size:16px; }
    .stats-list p{ margin:0; color:var(--text-muted); font-size:14px; }

    .activity-list{ list-style:none; padding:0; margin:0; display:flex; flex-direction:column; gap:12px; }
    .activity-item{
      border:1px solid var(--border);
      border-radius:10px;
      padding:12px 14px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .activity-header{ display:flex; justify-content:space-between; gap:10px; font-weight:700; }
    .activity-header span{ display:inline-flex; align-items:center; gap:6px; }
    .activity-note{ color:var(--text-muted); font-size:14px; }
    .activity-meta{ font-size:13px; color:var(--text-muted); display:flex; gap:10px; flex-wrap:wrap; }

    .achievements-grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:12px; }
    .achievement{
      border:1px dashed var(--border);
      border-radius:14px;
      padding:14px;
      background:rgba(255,255,255,0.6);
      display:flex;
      flex-direction:column;
      gap:6px;
      align-items:flex-start;
    }
    .achievement i{ font-size:20px; }
    .achievement strong{ font-size:16px; }
    .achievement p{ margin:0; font-size:13px; color:var(--text-muted); }
    .achievement.unlocked{
      border-style:solid;
      border-color:var(--accent);
      background:rgba(139,92,246,0.1);
      color:var(--accent);
    }
    .achievement.unlocked p{ color:inherit; }

    .friends-grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(160px,1fr)); gap:12px; }
    .friend-card{
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:8px;
      background:rgba(15,76,129,0.04);
    }
    .friend-avatar{
      width:44px;
      height:44px;
      border-radius:12px;
      background:var(--accent-soft);
      color:var(--accent);
      display:grid;
      place-items:center;
      font-weight:700;
    }
    .friend-meta{ font-size:13px; color:var(--text-muted); }

    .settings-card form{ display:flex; flex-direction:column; gap:14px; }
    .settings-card fieldset{ border:0; padding:0; margin:0; display:flex; flex-direction:column; gap:8px; }
    .settings-card legend{ font-weight:700; margin-bottom:4px; }
    .input{
      width:100%;
      padding:10px 12px;
      border:1px solid var(--border);
      border-radius:10px;
      font-size:15px;
      background:#fff;
      color:inherit;
    }
    .btn,
    .btn-primary{
      border-radius:10px;
      padding:10px 14px;
      font-weight:600;
      border:1px solid var(--border);
      background:#fff;
      cursor:pointer;
      transition: transform .16s ease, box-shadow .16s ease;
    }
    .btn-primary{
      background:var(--secondary);
      border-color:var(--secondary);
      color:#111;
      box-shadow:0 4px 12px rgba(246,196,83,0.4);
    }
    .btn:hover,
    .btn-primary:hover{ transform: translateY(-1px); box-shadow:0 6px 16px rgba(15,23,42,0.12); }
    .btn[aria-pressed="true"]{ background:var(--accent); color:#fff; border-color:var(--accent); }
    .settings-help{ font-size:13px; color:var(--text-muted); margin-top:-6px; }
    .settings-actions{ display:flex; gap:8px; flex-wrap:wrap; }

    small{ color:var(--text-muted); }

    .theme-toggle{ display:flex; justify-content:space-between; align-items:center; gap:12px; padding:14px; border:1px solid var(--border); border-radius:12px; background:rgba(139,92,246,0.06); }
    .theme-toggle strong{ font-size:15px; }

    .empty-state{
      border:2px dashed var(--border);
      border-radius:12px;
      padding:24px;
      text-align:center;
      color:var(--text-muted);
      background:rgba(255,255,255,0.5);
    }
    .empty-state a{ color:var(--accent); font-weight:700; }

    footer{ margin-top:32px; text-align:center; font-size:13px; color:var(--text-muted); }

    .dark-mode{ background:var(--bg-dark); color:var(--text); }
    .dark-mode .card,
    .dark-mode .activity-item,
    .dark-mode .friend-card,
    .dark-mode .theme-toggle,
    .dark-mode .stats-list li{ background:var(--card-dark); border:1px solid var(--border-dark-contrast); box-shadow: var(--shadow-dark); }
    .dark-mode .pill{ background:rgba(139,92,246,0.22); color:#f4ebff; border-color:rgba(139,92,246,0.5); box-shadow:0 4px 14px rgba(0,0,0,0.35); }
    .dark-mode .profile-name{ color: var(--text-strong); }
    .dark-mode .activity-note,
    .dark-mode .activity-meta,
    .dark-mode .friend-meta,
    .dark-mode .settings-help,
    .dark-mode footer{ color:var(--text-muted); }
    .dark-mode .achievement{ background:rgba(29,33,37,0.9); border-color:var(--border-dark); }
    .dark-mode .achievement.unlocked{ background:rgba(139,92,246,0.22); }
    .dark-mode .input{ background:#161b1f; border-color:var(--border-dark); color:inherit; }
    .dark-mode .btn{ background:#1f2429; border-color:var(--border-dark); }
    .dark-mode .btn-primary{ color:#111; }
    .dark-mode .empty-state{ background:rgba(29,33,37,0.8); border-color:var(--border-dark); }
    .dark-mode .banner{ border-color:var(--border-dark-contrast); }
    .dark-mode .banner-btn{
      border-color:rgba(255,255,255,0.24);
      background:rgba(20,26,32,0.68);
      color:var(--text-strong);
      box-shadow:0 10px 24px rgba(0,0,0,0.35);
      text-shadow:none;
    }

    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
      .avatar{ width:92px; height:92px; border-radius:20px; }
    }
    @media (max-width: 720px){
      .profile-core{ flex-wrap:wrap; }
      .profile-badges{ margin-left:0; justify-content:flex-start; width:100%; }
    }
    @media (max-width: 560px){
      .profile-badges{ gap:8px; }
      .stats-list{ grid-template-columns:1fr; }
      .banner{ height:140px; }
    }
    @media (min-width: 720px){
      .profile-info{
        flex-direction: row;
        align-items: baseline;
        flex-wrap: wrap;
        gap: 6px 12px;
      }
      .profile-name{ margin-right: 8px; }
      .profile-badges{
        margin-left: 0;
        justify-content: flex-start;
      }
    }

    .profile-info{ position: relative; }
    .profile-inline-name-editor{
      position:absolute;
      top:-6px;
      left:0;
      width:min(360px, 100%);
      padding:10px 16px;
      border-radius:12px;
      border:1px solid var(--border);
      background:#fff;
      color:inherit;
      font-size:24px;
      font-weight:700;
      line-height:1.2;
      box-shadow:var(--shadow);
      display:none;
      z-index:5;
    }
    .profile-inline-name-editor::placeholder{ color:var(--text-muted); font-weight:400; }
    .profile-info.is-inline-editing #profileNameDisplay{
      opacity:0;
      pointer-events:none;
    }
    .profile-info.is-inline-editing .profile-inline-name-editor{
      display:block;
    }
    .dark-mode .profile-inline-name-editor{
      background:var(--card-dark);
      border-color:var(--border-dark-contrast);
      color:var(--text);
      box-shadow:var(--shadow-dark);
    }
    .dark-mode .profile-inline-name-editor::placeholder{ color:var(--text-muted); }

    /* 1) No modo de edição, esconda o nome do fluxo */
    .profile-info.is-inline-editing #profileNameDisplay{
      display: none;           /* em vez de só opacity:0 */
    }

    /* 2) Faça o editor participar do fluxo para empurrar as badges */
    .profile-info.is-inline-editing .profile-inline-name-editor{
      position: static;        /* sai do absolute */
      display: inline-block;   /* ocupa só o necessário */
      width: auto;
      max-width: 100%;
      top: auto; left: auto;   /* garantias caso tenham ficado da regra anterior */
    }

    /* (opcional) Deixe a linha mais estável durante a edição */
    @media (min-width: 720px){
      .profile-info{           /* já é Flex + wrap; só reforçando */
        flex-direction: row;
        align-items: baseline;
        flex-wrap: wrap;
        gap: 6px 12px;
      }
    }

    :root{
      --text-strong: hsl(215 56% 18%);
      --text:        hsl(215 28% 26%);
      --text-muted:  hsl(217 17% 48%);
      --text-subtle: var(--text-muted);
      --text-dark:   var(--text-strong);
    }

    body{ color: var(--text); }

    .dark-mode{
      --text-strong: hsl(210 40% 96%);
      --text:        hsl(210 28% 92%);
      --text-muted:  hsl(215 20% 72%);
      --text-subtle: var(--text-muted);
      --text-dark:   var(--text-strong);
    }

    @media (prefers-color-scheme: dark){
      body:not(.dark-mode){
        --text-strong: hsl(210 40% 96%);
        --text:        hsl(210 25% 92%);
        --text-muted:  hsl(215 20% 72%);
      }
    }

    /* visual base dos botões do herói */
    .btn.hero-btn{
      border:1px solid rgba(11,48,66,.28);
      background:linear-gradient(135deg, rgba(255,255,255,.97), rgba(221,232,255,.9));
      color:#0b2533;
      padding:6px 14px; border-radius:999px;
      backdrop-filter:blur(8px); font-weight:600;
      text-shadow:0 1px 2px rgba(255,255,255,.65);
      box-shadow:0 6px 16px rgba(15,23,42,.15);
    }
    .btn.hero-btn:hover,.btn.hero-btn:focus-visible{
      background:linear-gradient(135deg,#fff,rgba(214,227,255,.98));
      box-shadow:0 10px 22px rgba(15,23,42,.22);
    }
    /* dark-mode: MAIS específico que .dark-mode .btn */
    .dark-mode .btn.hero-btn{
      background:linear-gradient(135deg, rgba(35,41,49,.95), rgba(51,59,72,.92));
      color:var(--text-dark);
      border-color:rgba(255,255,255,.18);
      text-shadow:none;
      box-shadow:0 10px 24px rgba(0,0,0,.35);
    }

    /* (Já existente) Nome + badges alinham por baseline em telas maiores */
    @media (min-width: 720px) {
      .profile-info {
        flex-direction: row;
        align-items: baseline;
        flex-wrap: wrap;
        gap: 6px 12px;
      }

      .profile-name {
        margin-right: 8px;
      }

      .profile-badges {
        margin-left: 0;
        justify-content: flex-start;
      }
    }

    /* Centraliza avatar + nome/pílulas + ações */
    .profile-core{
      display:flex;
      align-items:center !important;
      gap:16px;
    }
    /* Ações vão para a direita e viram coluna em telas pequenas (se quiser) */
    .profile-core .hero-actions{
      margin-left:auto;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    /* Mata qualquer posicionamento absoluto legado do banner */
    .profile-hero .hero-actions, .profile-hero .banner-btn{
      position:static !important;
      inset:auto !important;
    }
  </style>
</head>
<body>
  <script nonce="lmup-2025">
    if (!window.__LMU_PARTIAL__) {
      sessionStorage.setItem('lmu_goto','perfil.html'); // diga ao shell o alvo
      location.href = 'index.html';                     // volta para o shell SPA
    }
  </script>
  <a class="skip-link" href="#conteudo">Ir para o conteúdo principal</a>
  <main id="conteudo">
    <div class="wrap">
      <section class="card profile-hero" aria-labelledby="profileNameDisplay">
        <div class="banner" role="img" aria-label="Banner personalizado do perfil">
          <input id="bannerFileInput" class="sr-only" type="file" accept="image/png, image/jpeg, image/webp">
          <input id="avatarFileInput" class="sr-only" type="file" accept="image/png, image/jpeg, image/webp">
          <div id="bannerToast" role="status" aria-live="polite"></div>
        </div>
        <div class="profile-core">
          <div class="avatar" id="profileAvatar" aria-hidden="true">
            <span id="profileAvatarInitial">?</span>
          </div>
          <div class="profile-info">
            <div class="profile-name" id="profileNameDisplay">Visitante</div>
            <input id="profileNameInlineInput"
                   class="profile-inline-name-editor"
                   type="text"
                   maxlength="40"
                   autocomplete="name"
                   aria-label="Editar nome exibido"
                   placeholder="Digite seu nome exibido">
            <ul class="profile-badges" aria-label="Resumo rápido do perfil">
              <li class="pill">
                <span class="badge-label">Nível</span>
                <strong id="profileLevelBadge">1</strong>
              </li>
              <li class="pill">
                <strong id="profileTotalBadge">0</strong>
                <span class="badge-label">XP total</span>
              </li>
              <li class="pill">
                <strong id="profileAreasBadge">0</strong>
                <span class="badge-label">Áreas</span>
              </li>
            </ul>
          </div>
          <div class="hero-actions" role="group" aria-label="Ações rápidas do perfil">
            <button id="quickNameBtn"   class="btn hero-btn" type="button">Alterar nome</button>
            <button id="quickAvatarBtn" class="btn hero-btn" type="button">Alterar avatar</button>
            <button id="bannerEditBtn"  class="btn hero-btn banner-btn" type="button">Alterar banner</button>
          </div>
        </div>
      </section>

      <div class="grid">
        <div class="column main-column">
          <section class="card xp-dashboard-card" aria-labelledby="xpDashTitle">
            <h2 id="xpDashTitle">Dashboard de XP</h2>
            <div id="xpChartContainer">Gráfico será renderizado aqui</div>
          </section>

          <section class="card activity-card" aria-labelledby="activityTitle">
            <h2 id="activityTitle">Atividade recente</h2>
            <ul id="recentActivityList" class="activity-list" aria-live="polite"></ul>
          </section>

          <section class="card achievements-card" aria-labelledby="achievementsTitle">
            <h2 id="achievementsTitle">Conquistas</h2>
            <div id="achievementsList" class="achievements-grid"></div>
          </section>

          <section class="card friends-card" aria-labelledby="friendsTitle">
            <h2 id="friendsTitle">Amigos e mentores</h2>
            <div class="friends-grid" id="friendsGrid">
              <article class="friend-card">
                <div class="friend-avatar" aria-hidden="true">AB</div>
                <div>
                  <strong>Ana Borges</strong>
                  <div class="friend-meta">Mentora de UX — em breve</div>
                </div>
              </article>
              <article class="friend-card">
                <div class="friend-avatar" aria-hidden="true">LM</div>
                <div>
                  <strong>Luis Moraes</strong>
                  <div class="friend-meta">Parceiro de estudos — em breve</div>
                </div>
              </article>
              <article class="friend-card">
                <div class="friend-avatar" aria-hidden="true">VS</div>
                <div>
                  <strong>Você +</strong>
                  <div class="friend-meta">Convide amigos para comparar XP.</div>
                </div>
              </article>
            </div>
          </section>
        </div>

        <aside class="column side-column">
          <section class="card progress-card" aria-labelledby="progressTitle">
            <h2 id="progressTitle">Progresso</h2>
            <ul class="stats-list">
              <li>
                <h3>Progresso atual</h3>
                <p id="statLevel">Nível 1</p>
              </li>
              <li>
                <h3>Próximo marco</h3>
                <p id="statNextLevel">Faltam 100 XP para o próximo nível.</p>
              </li>
              <li>
                <h3>XP acumulado</h3>
                <p id="statTotalXp">0 XP registrados.</p>
              </li>
              <li>
                <h3>Áreas exploradas</h3>
                <p id="statAreas">Nenhuma área registrada ainda.</p>
              </li>
              <li>
                <h3>Streak de estudo</h3>
                <p id="statStreak">Nenhum dia consecutivo ainda.</p>
              </li>
            </ul>
          </section>

          <section class="card" aria-labelledby="tipsTitle">
            <h2 id="tipsTitle">Dicas rápidas</h2>
            <ul class="stats-list">
              <li>
                <h3>Revise conquistas</h3>
                <p>Veja o que falta para liberar os próximos badges.</p>
              </li>
              <li>
                <h3>Sincronize com amigos</h3>
                <p>Compartilhe seu link do Level Me Up! quando a funcionalidade estiver ativa.</p>
              </li>
              <li>
                <h3>Atualize metas</h3>
                <p>Use o registro de XP para planejar a próxima semana.</p>
              </li>
            </ul>
          </section>
        </aside>
      </div>

      <footer>
        Mais novidades em breve: banner personalizável, rede de amigos e badges dinâmicos.
      </footer>
    </div>
  </main>

  <div id="profileLive" class="sr-only" aria-live="polite"></div>

  <script nonce="lmup-2025" data-page-script>
  (() => {
    const K_NAME   = 'lmup_name';
    const K_AVATAR = 'lmup_avatar_v1';
    const K_BANNER = 'lmu.profile.banner';
    const K_THEME  = 'lmup_theme';
    const K_LEVEL  = 'lmup_level';
    const K_XP     = 'lmup_xp';
    const K_EVENTS = 'lmup_xp_events_v1';
    const BANNER_ALLOWED_TYPES = ['image/png', 'image/jpeg', 'image/webp'];
    const BANNER_MAX_SIZE = 3000000;

    const safeGet = (k, fb = '') => { try { const v = localStorage.getItem(k); return v ?? fb; } catch { return fb; } };
    const safeSet = (k, v) => { try { localStorage.setItem(k, v); } catch {} };
    const safeRemove = (k) => { try { localStorage.removeItem(k); } catch {} };

    const $ = (sel) => document.querySelector(sel);
    const live = $('#profileLive');
    const announce = (msg) => { if (live && msg) live.textContent = msg; };
    const bannerToastEl = $('#bannerToast');
    let bannerToastTimer = null;
    const showBannerToast = (message, type = 'success') => {
      if (!bannerToastEl || !message) return;
      bannerToastEl.textContent = message;
      bannerToastEl.classList.remove('is-success', 'is-error', 'is-visible');
      void bannerToastEl.offsetWidth;
      bannerToastEl.classList.add(type === 'error' ? 'is-error' : 'is-success');
      bannerToastEl.classList.add('is-visible');
      if (bannerToastTimer) {
        clearTimeout(bannerToastTimer);
        bannerToastTimer = null;
      }
      bannerToastTimer = setTimeout(() => {
        bannerToastEl.classList.remove('is-visible');
      }, 3800);
    };

    const pad = (n) => String(n).padStart(2, '0');
    const dayKey = (value) => {
      if (!value) return '';
      const d = new Date(value);
      if (Number.isNaN(d.getTime())) return '';
      return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}`;
    };

    const xpNeededForLevel = (lvl) => Math.max(100, lvl * 100);
    const loadProgress = () => {
      let level = parseInt(safeGet(K_LEVEL, '1'), 10);
      let xp = parseInt(safeGet(K_XP, '0'), 10);
      if (Number.isNaN(level) || level < 1) level = 1;
      if (Number.isNaN(xp) || xp < 0) xp = 0;
      return { level, xp };
    };
    const loadEvents = () => {
      try {
        return JSON.parse(localStorage.getItem(K_EVENTS) || '[]') || [];
      } catch {
        return [];
      }
    };

    const totalXpFromProgress = (level, xp) => {
      let total = xp;
      for (let i = 1; i < level; i += 1) {
        total += xpNeededForLevel(i);
      }
      return total;
    };

    const computeAreas = (events) => {
      const areas = new Set();
      events.forEach((ev) => {
        const area = (ev?.area || '').trim();
        if (area) areas.add(area);
      });
      return areas;
    };

    const computeStreak = (events) => {
      if (!events.length) return 0;
      const set = new Set(events.map((ev) => dayKey(ev.ts || ev.time)));
      if (!set.size) return 0;
      const now = new Date();
      let streak = 0;
      for (let offset = 0; offset < 365; offset += 1) {
        const day = new Date(now.getFullYear(), now.getMonth(), now.getDate() - offset);
        const key = `${day.getFullYear()}-${pad(day.getMonth() + 1)}-${pad(day.getDate())}`;
        if (set.has(key)) {
          streak += 1;
        } else {
          break;
        }
      }
      return streak;
    };

    const formatDateTime = (value) => {
      const d = new Date(value);
      if (Number.isNaN(d.getTime())) return 'Data desconhecida';
      return new Intl.DateTimeFormat('pt-BR', { dateStyle: 'medium', timeStyle: 'short' }).format(d);
    };

    const formatRelative = (value) => {
      const d = new Date(value);
      if (Number.isNaN(d.getTime())) return 'Sem registro ainda';
      const now = new Date();
      const diff = now - d;
      const dayMs = 24 * 60 * 60 * 1000;
      const days = Math.floor(diff / dayMs);
      if (days <= 0) return 'Hoje';
      if (days === 1) return 'Ontem';
      if (days < 7) return `${days} dias atrás`;
      const weeks = Math.floor(days / 7);
      if (weeks === 1) return 'Há 1 semana';
      if (weeks < 5) return `Há ${weeks} semanas`;
      return new Intl.DateTimeFormat('pt-BR', { dateStyle: 'medium' }).format(d);
    };

    const updateThemeMeta = () => {
      const metas = document.querySelectorAll('meta[name="theme-color"]');
      const isDark = document.body.classList.contains('dark-mode');
      const color = isDark ? '#0b2533' : '#0b3042';
      metas.forEach((meta) => meta.setAttribute('content', color));
    };

    const updateThemeToggleUI = () => {
      const btn = $('#profileThemeToggle');
      if (!btn) return;
      const isDark = document.body.classList.contains('dark-mode');
      btn.textContent = isDark ? 'Ativar modo claro' : 'Ativar modo escuro';
      btn.setAttribute('aria-pressed', String(isDark));
    };

    const applyThemePreference = () => {
      const stored = safeGet(K_THEME, 'light');
      const shouldDark = stored === 'dark';
      document.body.classList.toggle('dark-mode', shouldDark);
      updateThemeMeta();
      updateThemeToggleUI();
    };

    const renderBanner = () => {
      const banner = $('.banner');
      if (!banner) return;
      const stored = (safeGet(K_BANNER, '') || '').trim();
      if (stored) {
        const sanitized = stored
          .replace(/'/g, '%27')
          .replace(/"/g, '%22');
        banner.style.setProperty('--banner-photo', `url('${sanitized}')`);
        banner.dataset.hasImage = 'true';
        banner.setAttribute('aria-label', 'Banner personalizado do perfil com imagem enviada.');
      } else {
        banner.style.removeProperty('--banner-photo');
        banner.removeAttribute('data-has-image');
        banner.setAttribute('aria-label', 'Banner padrão do perfil.');
      }
    };

    const renderProfile = () => {
      const name = (safeGet(K_NAME, '') || '').trim() || 'Visitante';
      const avatar = (safeGet(K_AVATAR, '') || '').trim();
      const { level, xp } = loadProgress();
      const events = loadEvents();
      const areas = computeAreas(events);
      const totalXp = Math.max(
        totalXpFromProgress(level, xp),
        events.reduce((acc, ev) => acc + Number(ev?.delta || 0), 0)
      );

      const nameDisplay = $('#profileNameDisplay');
      if (nameDisplay) nameDisplay.textContent = name;

      const avatarBox = $('#profileAvatar');
      if (avatarBox) {
        avatarBox.innerHTML = '';
        if (avatar) {
          const img = document.createElement('img');
          img.src = avatar;
          img.alt = `Avatar de ${name}`;
          avatarBox.appendChild(img);
        } else {
          const span = document.createElement('span');
          const first = name.trim()[0] ? name.trim()[0].toUpperCase() : '?';
          span.textContent = first;
          span.id = 'profileAvatarInitial';
          avatarBox.appendChild(span);
        }
      }

      const profileLevelBadge = $('#profileLevelBadge');
      if (profileLevelBadge) profileLevelBadge.textContent = String(level);
      const profileTotalBadge = $('#profileTotalBadge');
      if (profileTotalBadge) profileTotalBadge.textContent = String(totalXp);
      const profileAreasBadge = $('#profileAreasBadge');
      if (profileAreasBadge) profileAreasBadge.textContent = String(areas.size);

      const nameInput = $('#profileNameInput');
      if (nameInput && document.activeElement !== nameInput) nameInput.value = name;

      const inlineNameInput = $('#profileNameInlineInput');
      const isInlineEditing = inlineNameInput?.closest('.profile-info')?.classList.contains('is-inline-editing');
      if (inlineNameInput && !isInlineEditing && document.activeElement !== inlineNameInput) {
        inlineNameInput.value = name;
      }

      const avatarInput = $('#profileAvatarInput');
      if (avatarInput && document.activeElement !== avatarInput) avatarInput.value = avatar;
    };

    const renderStats = () => {
      const { level, xp } = loadProgress();
      const needed = xpNeededForLevel(level);
      const events = loadEvents();
      const areas = computeAreas(events);
      const streak = computeStreak(events);
      const total = Math.max(
        totalXpFromProgress(level, xp),
        events.reduce((acc, ev) => acc + Number(ev?.delta || 0), 0)
      );

      const statLevel = $('#statLevel');
      if (statLevel) statLevel.textContent = `Nível ${level} — ${xp} XP no nível atual.`;
      const statNext = $('#statNextLevel');
      if (statNext) statNext.textContent = `Faltam ${Math.max(0, needed - xp)} XP para subir para o nível ${level + 1}.`;
      const statTotal = $('#statTotalXp');
      if (statTotal) statTotal.textContent = total > 0 ? `${total} XP acumulados ao todo.` : '0 XP registrados.';
      const statAreas = $('#statAreas');
      if (statAreas) statAreas.textContent = areas.size ? `${areas.size} área(s) diferentes registradas.` : 'Nenhuma área registrada ainda.';
      const statStreak = $('#statStreak');
      if (statStreak) statStreak.textContent = streak ? `${streak} dia(s) consecutivos de estudo.` : 'Nenhum dia consecutivo ainda.';
    };

    const renderActivity = () => {
      const list = $('#recentActivityList');
      if (!list) return;
      list.innerHTML = '';
      const events = loadEvents()
        .slice()
        .sort((a, b) => new Date(b.ts || 0) - new Date(a.ts || 0))
        .slice(0, 6);
      if (!events.length) {
        const empty = document.createElement('div');
        empty.className = 'empty-state';
        empty.innerHTML = 'Sem atividades ainda. <a href="progresso.html" data-nav="progresso">Registre XP na página de progresso</a> para preencher este histórico.';
        list.appendChild(empty);
        return;
      }
      events.forEach((ev) => {
        const item = document.createElement('li');
        item.className = 'activity-item';
        const header = document.createElement('div');
        header.className = 'activity-header';
        const xp = document.createElement('span');
        xp.innerHTML = `<i class="fa-solid fa-bolt"></i> +${Number(ev?.delta || 0)} XP`;
        const area = document.createElement('span');
        const areaName = (ev?.area || 'Área geral').trim() || 'Área geral';
        area.innerHTML = `<i class="fa-solid fa-layer-group"></i> ${areaName}`;
        header.appendChild(xp);
        header.appendChild(area);
        item.appendChild(header);

        if (ev?.note) {
          const note = document.createElement('div');
          note.className = 'activity-note';
          note.textContent = ev.note;
          item.appendChild(note);
        }

        const meta = document.createElement('div');
        meta.className = 'activity-meta';
        const time = document.createElement('time');
        time.dateTime = ev?.ts || '';
        time.textContent = formatDateTime(ev?.ts || ev?.time);
        meta.appendChild(time);
        item.appendChild(meta);

        list.appendChild(item);
      });
    };

    const renderAchievements = () => {
      const container = $('#achievementsList');
      if (!container) return;
      container.innerHTML = '';

      const { level, xp } = loadProgress();
      const events = loadEvents();
      const areas = computeAreas(events).size;
      const streak = computeStreak(events);
      const total = Math.max(
        totalXpFromProgress(level, xp),
        events.reduce((acc, ev) => acc + Number(ev?.delta || 0), 0)
      );

      const achievements = [
        {
          id: 'first-xp',
          icon: 'fa-seedling',
          title: 'Primeiro passo',
          desc: 'Ganhe XP pela primeira vez.',
          unlocked: total > 0,
        },
        {
          id: 'level-5',
          icon: 'fa-rocket',
          title: 'Impulsionado',
          desc: 'Alcance o nível 5.',
          unlocked: level >= 5,
        },
        {
          id: 'areas-3',
          icon: 'fa-compass',
          title: 'Explorador',
          desc: 'Registre XP em 3 áreas diferentes.',
          unlocked: areas >= 3,
        },
        {
          id: 'streak-3',
          icon: 'fa-fire',
          title: 'Foco total',
          desc: 'Mantenha uma sequência de 3 dias.',
          unlocked: streak >= 3,
        },
        {
          id: 'level-10',
          icon: 'fa-trophy',
          title: 'Mentor em formação',
          desc: 'Chegue ao nível 10.',
          unlocked: level >= 10,
        },
      ];

      achievements.forEach((ach) => {
        const card = document.createElement('article');
        card.className = `achievement${ach.unlocked ? ' unlocked' : ''}`;
        card.setAttribute('data-achievement', ach.id);
        const icon = document.createElement('i');
        icon.className = `fa-solid ${ach.icon}`;
        icon.setAttribute('aria-hidden', 'true');
        const title = document.createElement('strong');
        title.textContent = ach.title;
        const desc = document.createElement('p');
        desc.textContent = ach.desc;
        if (!ach.unlocked) {
          const lock = document.createElement('span');
          lock.className = 'settings-help';
          lock.textContent = 'Em progresso';
          desc.appendChild(document.createTextNode(' '));
          desc.appendChild(lock);
        }
        card.appendChild(icon);
        card.appendChild(title);
        card.appendChild(desc);
        container.appendChild(card);
      });
    };

    const refreshAll = () => {
      applyThemePreference();
      renderBanner();
      renderProfile();
      renderStats();
      renderActivity();
      renderAchievements();
    };

    const bindEvents = () => {
      const nameForm = $('#profileNameForm');
      if (nameForm && !nameForm.__lmu_bound) {
        nameForm.addEventListener('submit', (event) => {
          event.preventDefault();
          const input = $('#profileNameInput');
          const value = (input?.value || '').trim();
          const finalValue = value || 'Visitante';
          safeSet(K_NAME, finalValue);
          renderProfile();
          announce('Nome atualizado com sucesso.');
          const ev = new Event('lmu:name-changed');
          window.dispatchEvent(ev);
          window.refreshNameOnTopbar?.();
        });
        nameForm.__lmu_bound = true;
      }

      const avatarForm = $('#profileAvatarForm');
      if (avatarForm && !avatarForm.__lmu_bound) {
        avatarForm.addEventListener('submit', (event) => {
          event.preventDefault();
          const input = $('#profileAvatarInput');
          const value = (input?.value || '').trim();
          if (value) {
            safeSet(K_AVATAR, value);
            announce('Avatar atualizado.');
          } else {
            safeRemove(K_AVATAR);
            announce('Avatar removido.');
          }
          renderProfile();
        });
        avatarForm.__lmu_bound = true;
      }

      const avatarReset = $('#profileAvatarReset');
      if (avatarReset && !avatarReset.__lmu_bound) {
        avatarReset.addEventListener('click', () => {
          safeRemove(K_AVATAR);
          renderProfile();
          announce('Avatar removido.');
        });
        avatarReset.__lmu_bound = true;
      }

      const themeBtn = $('#profileThemeToggle');
      if (themeBtn && !themeBtn.__lmu_bound) {
        themeBtn.addEventListener('click', () => {
          const willDark = !document.body.classList.contains('dark-mode');
          document.body.classList.toggle('dark-mode', willDark);
          safeSet(K_THEME, willDark ? 'dark' : 'light');
          updateThemeMeta();
          updateThemeToggleUI();
          announce(willDark ? 'Modo escuro ativado.' : 'Modo claro ativado.');
          window.dispatchEvent(new Event('lmu:theme-changed'));
        });
        themeBtn.__lmu_bound = true;
      }

      const startInlineNameEdit = () => {
        const container = $('.profile-info');
        const display = $('#profileNameDisplay');
        const input = $('#profileNameInlineInput');
        if (!container || !display || !input) return;

        if (container.classList.contains('is-inline-editing')) {
          if (document.activeElement !== input) {
            input.focus();
            input.select();
          }
          return;
        }

        const storedName = (safeGet(K_NAME, '') || '').trim();
        const fallbackName = (display.textContent || '').trim();
        input.value = storedName || fallbackName || '';

        container.classList.add('is-inline-editing');
        display.setAttribute('aria-hidden', 'true');

        let finished = false;
        const cleanup = (shouldSave) => {
          if (finished) return;
          finished = true;
          input.removeEventListener('keydown', handleKeydown);
          input.removeEventListener('blur', handleBlur);
          container.classList.remove('is-inline-editing');
          display.removeAttribute('aria-hidden');

          if (!shouldSave) {
            renderProfile();
            return;
          }

          const rawValue = (input.value || '').trim();
          const finalValue = rawValue || 'Visitante';
          safeSet(K_NAME, finalValue);
          renderProfile();
          announce('Nome atualizado com sucesso.');
          window.dispatchEvent(new Event('lmu:name-changed'));
          window.refreshNameOnTopbar?.();
        };

        const handleBlur = () => cleanup(true);
        const handleKeydown = (event) => {
          if (event.key === 'Enter') {
            event.preventDefault();
            cleanup(true);
          } else if (event.key === 'Escape') {
            event.preventDefault();
            cleanup(false);
          }
        };

        input.addEventListener('keydown', handleKeydown);
        input.addEventListener('blur', handleBlur);

        requestAnimationFrame(() => {
          input.focus();
          input.select();
        });
      };

      const quickName = $('#quickNameBtn');
      if (quickName && !quickName.__lmu_bound) {
        quickName.addEventListener('click', startInlineNameEdit);
        quickName.__lmu_bound = true;
      }

      const nameDisplay = $('#profileNameDisplay');
      if (nameDisplay && !nameDisplay.__lmu_inline_bound) {
        nameDisplay.addEventListener('dblclick', startInlineNameEdit);
        nameDisplay.__lmu_inline_bound = true;
      }

      // Listener de clique para abrir o file picker e Listener de upload do avatar
      const quickAvatar = $('#quickAvatarBtn');
      if (quickAvatar && !quickAvatar.__lmu_bound) {
        const avatarInput = $('#avatarFileInput');
        // Trecho que substitui o antigo (que só rolava a página)
        quickAvatar.addEventListener('click', () => {
          if (avatarInput) {
            avatarInput.value = '';
            avatarInput.click();        // abre o file picker
          } else {
            announce('Não foi possível abrir o seletor de arquivos.');
          }
        });
        quickAvatar.__lmu_bound = true;
      }

      // Listener de upload do avatar (parecido com o do banner)
      const AVATAR_MAX_SIZE = 2000000; // ~2MB (evita estourar o localStorage)
      const AVATAR_ALLOWED_TYPES = ['image/png', 'image/jpeg', 'image/webp'];
      const avatarInput = $('#avatarFileInput'); // Re-obter o input, se necessário

      if (avatarInput && !avatarInput.__lmu_bound) {
        avatarInput.addEventListener('change', () => {
          const [file] = avatarInput.files || [];
          if (!file) return;

          const okTipo = file.type
            ? AVATAR_ALLOWED_TYPES.includes(file.type)
            : /\.(png|jpe?g|webp)$/i.test(file.name || '');
          if (!okTipo) {
            announce('Selecione uma imagem PNG, JPG ou WEBP.');
            avatarInput.value = '';
            return;
          }
          if (file.size > AVATAR_MAX_SIZE) {
            announce('O arquivo é muito grande (máx. 2MB).');
            avatarInput.value = '';
            return;
          }
          if (typeof FileReader === 'undefined') {
            announce('Seu navegador não suporta upload de imagem.');
            avatarInput.value = '';
            return;
          }

          const reader = new FileReader();
          reader.addEventListener('load', () => {
            const { result } = reader;
            if (typeof result === 'string' && result.startsWith('data:')) {
              safeSet(K_AVATAR, result);   // salva o data URL
              renderProfile();             // atualiza o avatar na UI
              announce('Avatar atualizado.');
            } else {
              announce('Não foi possível atualizar o avatar.');
            }
            avatarInput.value = '';
          });
          reader.addEventListener('error', () => {
            announce('Falha ao ler o arquivo selecionado.');
            avatarInput.value = '';
          });

          try {
            reader.readAsDataURL(file);
          } catch {
            announce('Não foi possível processar o arquivo do avatar.');
            avatarInput.value = '';
          }
        });
        avatarInput.__lmu_bound = true;
      }

      const bannerInput = $('#bannerFileInput');
      const bannerBtn = $('#bannerEditBtn');
      if (bannerBtn && !bannerBtn.__lmu_bound) {
        bannerBtn.addEventListener('click', () => {
          if (bannerInput) {
            bannerInput.value = '';
            bannerInput.click();
          } else {
            announce('Não foi possível abrir o seletor de arquivos.');
          }
        });
        bannerBtn.__lmu_bound = true;
      }

      if (bannerInput && !bannerInput.__lmu_bound) {
        bannerInput.addEventListener('change', () => {
          const [file] = bannerInput.files || [];
          if (!file) return;

          const matchesType = file.type
            ? BANNER_ALLOWED_TYPES.includes(file.type)
            : /\.(png|jpe?g|webp)$/i.test(file.name || '');
          if (!matchesType) {
            announce('Selecione uma imagem válida para o banner.');
            showBannerToast('Erro: Formato de arquivo não suportado.', 'error');
            bannerInput.value = '';
            return;
          }

          if (file.size > BANNER_MAX_SIZE) {
            announce('O arquivo é muito grande. O limite é de 3MB.');
            showBannerToast('Erro: Arquivo muito grande (máximo 3MB).', 'error');
            bannerInput.value = '';
            return;
          }

          if (typeof FileReader === 'undefined') {
            announce('Seu navegador não suporta upload de banner.');
            showBannerToast('Erro: Navegador não suporta upload de banner.', 'error');
            bannerInput.value = '';
            return;
          }

          const reader = new FileReader();
          reader.addEventListener('load', () => {
            const { result } = reader;
            if (typeof result === 'string' && result.startsWith('data:')) {
              safeSet(K_BANNER, result);
              renderBanner();
              announce('Banner atualizado com sucesso.');
              showBannerToast('Banner atualizado!', 'success');
            } else {
              announce('Não foi possível atualizar o banner.');
              showBannerToast('Erro: Não foi possível atualizar o banner.', 'error');
            }
            bannerInput.value = '';
          });
          reader.addEventListener('error', () => {
            announce('Não foi possível ler o arquivo selecionado.');
            showBannerToast('Erro: Falha ao ler o arquivo selecionado.', 'error');
            bannerInput.value = '';
          });

          try {
            reader.readAsDataURL(file);
          } catch (err) {
            console.error(err);
            announce('Não foi possível processar o arquivo de banner.');
            showBannerToast('Erro: Não foi possível processar o banner.', 'error');
            bannerInput.value = '';
          }
        });
        bannerInput.__lmu_bound = true;
      }
    };

    const handleStorage = (event) => {
      if (!event) return;
      if (event.key === K_NAME || event.key === K_AVATAR) {
        renderProfile();
      }
      if (event.key === K_BANNER) {
        renderBanner();
      }
      if (event.key === K_LEVEL || event.key === K_XP || event.key === K_EVENTS) {
        renderStats();
        renderActivity();
        renderAchievements();
      }
      if (event.key === K_THEME) {
        applyThemePreference();
      }
    };

    const handleNameChanged = () => { renderProfile(); };
    const handleThemeChanged = () => { updateThemeToggleUI(); updateThemeMeta(); };

    const init = () => {
      bindEvents();
      refreshAll();
    };

    window.addEventListener('storage', handleStorage);
    window.addEventListener('lmu:name-changed', handleNameChanged);
    window.addEventListener('lmu:theme-changed', handleThemeChanged);

    init();

    window.initPerfilPage = init;
  })();
  </script>
</body>
</html>
