<!DOCTYPE html>
<html lang="pt-BR" dir="ltr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Level Me Up!</title>
  <meta name="description" content="Level Me Up! — evolua suas habilidades por áreas de conhecimento, com progresso, favoritos e PWA." />

  <!-- Favicon neutro para evitar 404 -->
  <link rel="icon" href="data:,">
  <link rel="shortcut icon" href="data:,">

  <!-- SEO / Social -->
  <link rel="canonical" href="./" />
  <meta property="og:type" content="website" />
  <meta property="og:title" content="Level Me Up!" />
  <meta property="og:description" content="Mapa de aprendizado com progresso, favoritos e PWA." />
  <meta property="og:url" content="./" />
  <meta property="og:image" content="./icon-512.png" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Level Me Up!" />
  <meta name="twitter:description" content="Mapa de aprendizado com progresso, favoritos e PWA." />
  <meta name="twitter:image" content="./icon-512.png" />

  <!-- Theme color (light/dark) -->
  <meta name="theme-color" content="#0b3042" media="(prefers-color-scheme: light)">
  <meta name="theme-color" content="#0b2533" media="(prefers-color-scheme: dark)">

  <!-- PWA -->
  <link rel="manifest" href="manifest.json" />

  <!-- Prefetch -->
  <link rel="prefetch" href="progresso.html" as="document" />
  <link rel="prefetch" href="perfil.html" as="document" />

  <!-- CSP -->
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self';
                 script-src 'self' 'nonce-lmup-2025';
                 style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdnjs.cloudflare.com;
                 img-src 'self' data:;
                 font-src 'self' https://fonts.gstatic.com https://cdnjs.cloudflare.com;
                 connect-src 'self';
                 object-src 'none';
                 base-uri 'none';
                 worker-src 'self'">

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;600;700&display=swap" rel="stylesheet" />

  <!-- Ícones -->
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
        crossorigin="anonymous"
        referrerpolicy="no-referrer" />

  <style>
    :root{
      color-scheme: light dark;
      --color-primary: hsl(198 70% 15%);
      --color-secondary: hsl(35 99% 68%);
      --color-bg: hsl(0 0% 97%);
      --color-text: hsl(0 0% 20%);
      --color-accent: hsl(265 100% 65%);
      --color-softgray: hsl(0 0% 93%);
      --color-border: hsl(0 0% 86%);
      --color-bg-dark: hsl(0 0% 12%);
      --color-text-dark: hsl(0 0% 99%);
      --color-card-bg-dark: hsl(0 0% 17%);
      --color-sidebar-bg-dark: hsl(0 0% 16%);
      --color-border-dark: hsl(0 0% 27%);
      --color-border-dark-contrast: hsl(0 0% 88%);
      --color-topbar-bg-dark: hsl(198 63% 12%);
      --focus-ring: hsl(265 100% 60%);
      --tap-min: 24px;
      --radius: 6px;
      --elev: 0 6px 18px rgba(0,0,0,0.1);
      --color-gold: hsl(45 100% 56%);
    }
    @supports(color: oklch(60% 0.1 200)){
      :root{
        --color-primary: oklch(34% 0.07 235);
        --color-secondary: oklch(84% 0.16 86);
        --color-bg: oklch(97% 0 0);
        --color-text: oklch(28% 0.03 255);
        --color-accent: oklch(54% 0.29 285);
        --color-softgray: oklch(93% 0.01 255);
        --color-border: oklch(86% 0.02 255);
        --color-bg-dark: oklch(20% 0.01 255);
        --color-text-dark: oklch(99% 0 0);
        --color-card-bg-dark: oklch(28% 0.01 255);
        --color-sidebar-bg-dark: oklch(27% 0.01 255);
        --color-border-dark: oklch(40% 0.02 255);
        --color-border-dark-contrast: oklch(88% 0.01 255);
        --color-topbar-bg-dark: oklch(28% 0.05 235);
        --focus-ring: oklch(54% 0.29 285);
        --color-gold: oklch(82% 0.17 85);
      }
    }
    @supports (accent-color: auto) { :root{ accent-color: var(--color-accent); } }

    *{ box-sizing: border-box; }
    html{ scroll-behavior: smooth; scroll-padding-top:72px; }
    body{
      margin:0; font-family:'Open Sans', system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: var(--color-bg); color: var(--color-text);
    }
    .sr-only{ position:absolute!important; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0; }
    .skip-link{
      position:absolute; left:8px; top:8px; background: var(--color-secondary); color:#111;
      padding:6px 10px; border-radius: var(--radius); transform: translateY(-200%); transition: transform .2s; z-index:2001;
    }
    .skip-link:focus-visible{ transform: translateY(0); outline: 3px solid var(--focus-ring); }
    :where(a,button,input,select,textarea,[tabindex]):focus-visible{ outline:3px solid var(--focus-ring); outline-offset:2px; }
    :where(button,a,.hit-target){ min-width:var(--tap-min); min-height:var(--tap-min); touch-action: manipulation; }
    @media (prefers-reduced-motion: reduce){ *{ animation:none!important; transition:none!important; } }

    .container{
      display:grid; grid-template-rows:auto 1fr; grid-template-columns:250px 1fr;
      grid-template-areas:"topbar topbar" "sidebar main"; min-height:100vh;
    }
    .topbar{
      grid-area:topbar; background:var(--color-primary); color:#fff;
      display:flex; align-items:center; justify-content:space-between; gap:12px; padding:0 16px; height:60px;
    }
    .topbar-left,.topbar-right{ display:flex; align-items:center; gap:12px; }
    .logo{ font-weight:700; font-size:18px; white-space:nowrap; }
    .menu-toggle{ display:none; background:transparent; border:0; color:#fff; font-size:20px; cursor:pointer; }

    .search-bar{ display:flex; align-items:center; }
    .search-bar input{
      padding:6px 8px; border:none; border-radius:4px; font-size:14px; max-width:220px; background:#fff; color:#111;
    }
    body.dark-mode .search-bar input{ background:#1e1e1e; color:#fff; border:1px solid var(--color-border-dark); }
    body.dark-mode .search-bar input::placeholder{ color:#cfcfcf; }

    /* Toggle "apenas favoritos" ao lado da busca */
    .fav-only-btn{
      margin-left:8px;
      border:1px solid rgba(0,0,0,.15);
      background:#fff;
      color:#111;
      border-radius:6px;
      padding:6px 8px;
      line-height:1;
    }
    .fav-only-btn i{ font-size:14px; }
    body.dark-mode .fav-only-btn{
      background:#1e1e1e;
      color:#fff;
      border-color: var(--color-border-dark);
    }
    /* quando ativo, estrela dourada */
    .fav-only-btn[aria-pressed="true"] i{ color:#f5c518; }
    .dev-xp-btn{
      margin-left:8px;
      padding:6px 10px;
      font-size:12px;
      line-height:1.2;
      font-weight:700;
      white-space:nowrap;
    }
    .dev-xp-btn:focus-visible{ outline:3px solid var(--focus-ring); }
    .user-greeting{ font-size:14px; white-space:nowrap; }
    .level-progress{ display:flex; align-items:center; gap:8px; }
    .progress-info{ font-size:14px; font-weight:600; }
    .progress-bar-container{ width:120px; height:10px; border-radius:6px; background:#fff; overflow:clip; }
    .progress-bar{ width:0%; height:100%; background:var(--color-secondary); transition:width 240ms cubic-bezier(.2,.7,.2,1); }

    .xp-button{ background:var(--color-secondary); color:#111; border:0; border-radius:4px; padding:8px 12px; font-size:14px; font-weight:600; cursor:pointer; }
    .xp-button:hover{ filter:brightness(1.05); }
    .xp-button:active{ transform: translateY(1px); }
    .dev-toggle-btn{
      background:transparent;
      color:#fff;
      border:1px dashed rgba(255,255,255,0.6);
      border-radius:4px;
      padding:6px 10px;
      font-size:12px;
      font-weight:600;
      letter-spacing:0.03em;
      cursor:pointer;
    }
    .dev-toggle-btn:focus-visible{ outline-color: var(--color-accent); }
    body.dark-mode .dev-toggle-btn{
      color: var(--color-text-dark);
      border-color: rgba(255,255,255,0.35);
      background: rgba(0,0,0,0.25);
    }
    .toggle-theme-btn{ background:transparent; color:#fff; border:2px solid #fff; border-radius:6px; padding:6px 10px; cursor:pointer; }
    .toggle-theme-btn:hover{ background:#fff; color:var(--color-primary); }
    body.dark-mode .toggle-theme-btn{ color:#fff; border-color:#fff; }

    .reset-btn{ background:#ff7272; color:#111; border:0; border-radius:6px; padding:8px 12px; font-weight:700; cursor:pointer; }
    .reset-btn:hover{ filter:brightness(1.05); }

    .sidebar{ grid-area:sidebar; background:#fff; border-right:1px solid var(--color-border); padding:20px; z-index:1000; transform: translateX(0); transition: transform .25s ease; }
    .sidebar h2{ font-size:18px; margin-bottom:15px; }
    .nav-section{ margin-bottom:25px; }
    .nav-section h3{ margin-bottom:10px; font-size:14px; font-weight:700; display:flex; align-items:center; gap:6px; }
    .nav-section ul{ list-style:none; padding-left:0; }
    .nav-section li{ margin-bottom:8px; }
    .nav-section a{ text-decoration:none; color:var(--color-text); font-size:14px; }
    .nav-section a:hover{ color:var(--color-accent); }

    .overlay{ display:none; position:fixed; top:60px; left:0; width:100%; height:calc(100vh - 60px); background:rgba(0,0,0,.5); z-index:999; }
    .overlay.show{ display:block; }

    .main{ grid-area:main; padding:20px; overflow-y:auto; }
    .main :is(h2,h3,[id]){ scroll-margin-top:72px; }
    .main h2{ margin-bottom:15px; font-weight:700; font-size:22px; }

    .knowledge-area{ margin-top:30px; }
    .knowledge-area h3{
      font-size:18px; margin-bottom:10px; border-left:4px solid var(--color-primary);
      padding-left:8px; font-weight:700; color:var(--color-primary);
    }
    body.dark-mode .knowledge-area > h3{ color:var(--color-gold); border-left-color:var(--color-gold); }

    .subarea-grid{ display:grid; grid-template-columns: repeat(auto-fill, minmax(270px, 1fr)); gap:20px; margin-bottom:40px; }
    .subarea-card{
      position:relative; background:#fff; border:1px solid var(--color-border); border-radius:var(--radius);
      padding:15px; display:flex; flex-direction:column; gap:8px; transition:transform .2s, box-shadow .2s, border-color .2s;
    }
    .subarea-card:hover{ transform:translateY(-2px); box-shadow:var(--elev); border-color:var(--color-accent); }
    .subarea-card h4{ font-size:16px; margin:0 0 2px; font-weight:700; padding-right:44px; line-height:1.25; word-break:break-word; hyphens:auto; }
    .subarea-focus, .subarea-mestre{ font-size:13px; line-height:1.45; }
    .subarea-mestre{ padding:8px; margin-top:auto; background:var(--color-softgray); border-radius:4px; }

    /* FAVORITOS */
    .fav-btn{
      position:absolute; top:10px; right:10px; width:32px; height:32px;
      display:inline-flex !important; align-items:center; justify-content:center;
      border-radius:50%; background:transparent; border:0; cursor:pointer;
      z-index:5; opacity:1 !important;
    }
    .fav-btn:focus-visible{ outline:3px solid var(--focus-ring); }
    .fav-btn .fa-star{ font-size:20px; }
    .subarea-card .fav-btn .fa-star{ color:#6b7280; }
    body.dark-mode .subarea-card .fav-btn .fa-star{ color:#e5e7eb; }
    .subarea-card .fav-btn.fav-active .fa-star{ color:#f5c518 !important; }
    body.dark-mode .subarea-card .fav-btn.fav-active .fa-star{ color:#f5c518 !important; }

    body.dark-mode{ background:var(--color-bg-dark); color:var(--color-text-dark); }
    body.dark-mode .topbar{ background:var(--color-topbar-bg-dark); color:var(--color-text-dark); }
    body.dark-mode .sidebar{ background:var(--color-sidebar-bg-dark); border-right:1px solid var(--color-border-dark); }
    body.dark-mode .subarea-card{ background:var(--color-card-bg-dark); border:1px solid var(--color-border-dark-contrast); color:var(--color-text-dark); }
    body.dark-mode .nav-section a{ color:var(--color-text-dark); }
    body.dark-mode .nav-section a:hover{ color:var(--color-accent); }
    body.dark-mode .subarea-mestre{ background:hsl(0 0% 26%); }
    body.dark-mode .fav-btn::after{
      content:""; position:absolute; inset:-4px; border:1.6px solid rgba(255,255,255,.9); border-radius:50%; pointer-events:none;
    }

    @media (max-width:768px){
      .container{ grid-template-columns:1fr; grid-template-areas:"topbar" "main"; }
      .sidebar{
        position:fixed; top:60px; left:-250px; width:250px; height:calc(100vh - 60px);
        background:#fff; box-shadow:2px 0 10px rgba(0,0,0,.2); transform: translateX(0);
        transition: transform .25s ease; will-change: transform; -webkit-backface-visibility:hidden; backface-visibility:hidden;
      }
      .menu-toggle{ display:inline-flex; align-items:center; justify-content:center; }
      .overlay.show + .sidebar{ transform: translateX(250px); }
    }

    [id]{ scroll-margin-top:72px; }

    /* Modal */
    dialog[levelup]{ text-align:center; padding:18px 20px; border-radius:10px; }
    dialog[levelup] .trophy{ margin-bottom:10px; }
    dialog[levelup] .dialog-title{ margin:0 0 8px; font-size:22px; color:var(--color-primary); }
    dialog[levelup] p{ margin:0 0 12px; }
    dialog[levelup] .close-modal-btn{ display:inline-block; margin:8px auto 0; }
    dialog::backdrop{ background:rgba(0,0,0,.45); }

    /* Link do logo */
    header .brand-link,
    .progress-header .brand-link {
      text-decoration: none;
      color: #fff;
      font-weight: 800;
      font-size: 18px;
      white-space: nowrap;
      margin-right: 12px;
    }
    header .brand-link:focus-visible,
    .progress-header .brand-link:focus-visible {
      outline: 2px solid #fff;
      outline-offset: 3px;
      border-radius: 6px;
    }
    header .brand-link:hover,
    .progress-header .brand-link:hover {
      text-decoration: underline;
      text-underline-offset: 2px;
    }

    /* Mensagem "sem resultados" */
    .no-results{
      margin: 16px 0 0 0;
      padding: 12px 14px;
      border: 1px dashed var(--color-border);
      border-radius: 8px;
      font-weight: 600;
      color: var(--color-primary);
      background: var(--color-softgray);
      display: none;
    }
    body.dark-mode .no-results{
      background: hsl(0 0% 22%);
      border-color: var(--color-border-dark);
      color: var(--color-text-dark);
    }

    /* Evita scroll quando sidebar está aberta */
    body.no-scroll{ overflow:hidden; }

    [hidden]{ display:none !important; }

    /* ===== Correções específicas do troféu no dark mode =====
       - Unifica tokens entre páginas: no dark mode, o accent vira dourado
       - Garante dourado mesmo com cor inline e ícones duotone do Font Awesome */
    body.dark-mode{
      --color-accent: var(--color-gold);
    }
    body.dark-mode #levelUpDialog .trophy,
    body.dark-mode #levelUpDialog .trophy i,
    body.dark-mode #levelUpDialog i.fa-trophy{
      color: var(--color-gold) !important;
      --fa-primary-color: var(--color-gold) !important;
      --fa-secondary-color: var(--color-gold) !important;
    }

    body:not(.dark-mode) .subarea-card{
      border:2px solid #000000;
    }
  </style>
</head>
<body>

  <a class="skip-link" href="#mainContent">Pular para o conteúdo principal</a>

  <div class="container" id="appRoot">
    <header class="topbar" role="banner">
      <div class="topbar-left">
        <button id="menuToggle" class="menu-toggle hit-target" type="button" aria-label="Abrir menu lateral" aria-controls="sidebar" aria-expanded="false">
          <i class="fas fa-bars" aria-hidden="true"></i>
        </button>
        <h1 class="logo" id="logoSite">
          <a href="index.html" class="brand-link" aria-label="Voltar para a página inicial">Level Me Up!</a>
        </h1>

        <search class="search-bar" id="searchBox">
          <form role="search" id="siteSearchForm" aria-label="Buscar subáreas">
            <label class="sr-only" for="siteSearchInput">Pesquisar habilidades</label>
            <input id="siteSearchInput" type="search" placeholder="Pesquisar habilidades..." autocomplete="off" />
          </form>
          <!-- Botão: apenas favoritos -->
          <button id="favOnlyBtn" class="fav-only-btn hit-target" type="button"
                  aria-pressed="false" title="Mostrar apenas favoritos">
            <i class="fa-regular fa-star" aria-hidden="true"></i>
            <span class="sr-only">Apenas favoritos</span>
          </button>
          <button id="devXpBtn" class="xp-button dev-xp-btn hit-target" type="button" title="Adicionar 10 XP">
            XP +10 DEV
          </button>
        </search>
      </div>

      <div class="topbar-right">
        <div class="user-greeting" id="userGreeting">Olá, Visitante!</div>

        <div class="level-progress" aria-label="Progresso de nível">
          <div class="progress-info" id="progressText">Nível 1</div>
          <div class="progress-bar-container" aria-hidden="true">
            <div class="progress-bar" id="progressBar"></div>
          </div>
        </div>

        <button class="dev-toggle-btn hit-target" id="devXpToggle" type="button" hidden aria-pressed="false" aria-label="Alternar botão de XP">XP Boost: Desligado</button>
        <button class="xp-button hit-target" id="xpBtn" type="button" aria-describedby="xpLive" hidden>+10 XP</button>
        <button class="toggle-theme-btn hit-target" id="themeToggle" type="button" aria-label="Alternar tema">
          <i class="fas fa-adjust" aria-hidden="true"></i>
        </button>
        <button class="reset-btn hit-target" id="resetProgressBtn" type="button" title="Zerar nível e XP">Resetar progresso</button>
      </div>
    </header>

    <div class="overlay" id="overlay" aria-hidden="true"></div>

    <aside class="sidebar" id="sidebar" aria-label="Menu lateral" tabindex="-1">
      <h2>Meu Perfil</h2>
      <nav aria-label="Navegação principal">
        <div class="nav-section">
          <h3><i class="fas fa-book-open" aria-hidden="true"></i> Aprendizado</h3>
          <ul>
            <li><a href="index.html#areas">Áreas do Conhecimento</a></li>
          </ul>
        </div>
        <div class="nav-section">
          <h3><i class="fas fa-user" aria-hidden="true"></i> Minha Conta</h3>
          <ul>
            <li><a href="progresso.html" data-nav="progresso">Progresso</a></li>
            <li><a href="perfil.html" data-nav="perfil">Perfil</a></li>
            <li><a href="#config">Configurações</a></li>
          </ul>
        </div>
        <div class="nav-section">
          <h3><i class="fas fa-trophy" aria-hidden="true"></i> Ranking</h3>
          <ul><li><a href="#leaderboard">Leaderboard</a></li></ul>
        </div>
        <div class="nav-section">
          <h3><i class="fas fa-medal" aria-hidden="true"></i> Conquistas</h3>
          <ul><li><a href="#achievements">Minhas Conquistas</a></li></ul>
        </div>
        <div class="nav-section">
          <h3><i class="fas fa-question-circle" aria-hidden="true"></i> Ajuda</h3>
          <ul>
            <li><a href="#faq">FAQ</a></li>
            <li><a href="#contato" target="_blank" rel="noopener noreferrer">Contato</a></li>
          </ul>
        </div>
      </nav>
    </aside>

    <main class="main" id="mainContent" role="main">
      <h2 id="areas">Áreas do Conhecimento</h2>

      <!-- Exatas -->
      <section class="knowledge-area" aria-labelledby="exatas-title">
        <h3 id="exatas-title">Ciências Exatas e da Natureza</h3>
        <div class="subarea-grid">
          <div class="subarea-card">
            <h4>Matemática e Lógica</h4>
            <div class="subarea-focus"><strong>Foco:</strong> Raciocínio lógico, estatística, probabilidade.</div>
            <div class="subarea-mestre"><strong>Mestre:</strong> Resolve problemas complexos e inova no raciocínio lógico.</div>
          </div>

          <div class="subarea-card">
            <h4>Física, Química e Astronomia</h4>
            <div class="subarea-focus"><strong>Foco:</strong> Leis naturais, matéria, energia e universo.</div>
            <div class="subarea-mestre"><strong>Mestre:</strong> Aplica conhecimento em pesquisa e desenvolvimento tecnológico.</div>
          </div>

          <div class="subarea-card">
            <h4>Biologia e Ciências da Vida</h4>
            <div class="subarea-focus"><strong>Foco:</strong> Organismos vivos, genética, ecossistemas.</div>
            <div class="subarea-mestre"><strong>Mestre:</strong> Melhora saúde e conservação ambiental.</div>
          </div>

          <div class="subarea-card">
            <h4>Geociências</h4>
            <div class="subarea-focus"><strong>Foco:</strong> Fenômenos geológicos, clima, oceanos.</div>
            <div class="subarea-mestre"><strong>Mestre:</strong> Antecipação de processos e uso sustentável de recursos.</div>
          </div>
        </div>
      </section>

      <!-- Humanas -->
      <section class="knowledge-area" aria-labelledby="humanas-title">
        <h3 id="humanas-title">Ciências Humanas e Sociais</h3>
        <div class="subarea-grid">
          <div class="subarea-card">
            <h4>História e Geografia Humana</h4>
            <div class="subarea-focus"><strong>Foco:</strong> Processos históricos, culturais e espaciais.</div>
            <div class="subarea-mestre"><strong>Mestre:</strong> Contextualiza fatos e gera insights.</div>
          </div>
          <div class="subarea-card">
            <h4>Filosofia e Ética</h4>
            <div class="subarea-focus"><strong>Foco:</strong> Existência, conhecimento, valores.</div>
            <div class="subarea-mestre"><strong>Mestre:</strong> Estrutura argumentos complexos e debates éticos.</div>
          </div>
        </div>
      </section>

      <!-- Artes -->
      <section class="knowledge-area" aria-labelledby="artes-title">
        <h3 id="artes-title">Artes, Literatura e Expressões Criativas</h3>
        <div class="subarea-grid">
          <div class="subarea-card">
            <h4>Artes Visuais</h4>
            <div class="subarea-focus"><strong>Foco:</strong> Pintura, escultura, fotografia.</div>
            <div class="subarea-mestre"><strong>Mestre:</strong> Domina técnicas e inova na expressão.</div>
          </div>
          <div class="subarea-card">
            <h4>Música</h4>
            <div class="subarea-focus"><strong>Foco:</strong> Teoria, composição, performance.</div>
            <div class="subarea-mestre"><strong>Mestre:</strong> Técnica e sensibilidade artística.</div>
          </div>
          <div class="subarea-card">
            <h4>Literatura, Escrita e Poética</h4>
            <div class="subarea-focus"><strong>Foco:</strong> Produção e análise de textos.</div>
            <div class="subarea-mestre"><strong>Mestre:</strong> Linguagem, estilo e crítica.</div>
          </div>
          <div class="subarea-card">
            <h4>Artes Cênicas</h4>
            <div class="subarea-focus"><strong>Foco:</strong> Interpretação, dramaturgia, direção.</div>
            <div class="subarea-mestre"><strong>Mestre:</strong> Cria experiências cênicas transformadoras.</div>
          </div>
        </div>
      </section>

      <!-- Tech -->
      <section class="knowledge-area" aria-labelledby="tech-title">
        <h3 id="tech-title">Tecnologia e Engenharia</h3>
        <div class="subarea-grid">
          <div class="subarea-card">
            <h4>Computação e Informática</h4>
            <div class="subarea-focus"><strong>Foco:</strong> Programação, algoritmos, IA, redes.</div>
            <div class="subarea-mestre"><strong>Mestre:</strong> Cria soluções tecnológicas avançadas.</div>
          </div>
          <div class="subarea-card">
            <h4>Engenharias (Civil, Elétrica, Mecânica…)</h4>
            <div class="subarea-focus"><strong>Foco:</strong> Projeto, operação e manutenção de sistemas.</div>
            <div class="subarea-mestre"><strong>Mestre:</strong> Soluções eficientes e sustentáveis.</div>
          </div>
          <div class="subarea-card">
            <h4>Novas Tecnologias e Inovação</h4>
            <div class="subarea-focus"><strong>Foco:</strong> Empreendedorismo tech, VR/AR, robótica.</div>
            <div class="subarea-mestre"><strong>Mestre:</strong> Adapta-se rápido às tendências.</div>
          </div>
        </div>
      </section>

      <!-- Saúde -->
      <section class="knowledge-area" aria-labelledby="saude-title">
        <h3 id="saude-title">Medicina, Saúde e Bem-Estar</h3>
        <div class="subarea-grid">
          <div class="subarea-card">
            <h4>Medicina, Enfermagem e Fisioterapia</h4>
            <div class="subarea-focus"><strong>Foco:</strong> Diagnóstico, tratamento, reabilitação.</div>
            <div class="subarea-mestre"><strong>Mestre:</strong> Cuidado integral e inovação terapêutica.</div>
          </div>
          <div class="subarea-card">
            <h4>Nutrição e Esportes</h4>
            <div class="subarea-focus"><strong>Foco:</strong> Alimentação, fisiologia do exercício.</div>
            <div class="subarea-mestre"><strong>Mestre:</strong> Personaliza rotinas eficazes.</div>
          </div>
          <div class="subarea-card">
            <h4>Psicologia da Saúde, Terapias Complementares</h4>
            <div class="subarea-focus"><strong>Foco:</strong> Saúde mental e terapias integrativas.</div>
            <div class="subarea-mestre"><strong>Mestre:</strong> Melhoria tangível do bem-estar.</div>
          </div>
        </div>
      </section>

      <!-- Gestão -->
      <section class="knowledge-area" aria-labelledby="gestao-title">
        <h3 id="gestao-title">Gestão, Negócios e Empreendedorismo</h3>
        <div class="subarea-grid">
          <div class="subarea-card">
            <h4>Administração e Gestão de Projetos</h4>
            <div class="subarea-focus"><strong>Foco:</strong> Planejamento, liderança, métricas.</div>
            <div class="subarea-mestre"><strong>Mestre:</strong> Coordena projetos complexos.</div>
          </div>
          <div class="subarea-card">
            <h4>Marketing e Vendas</h4>
            <div class="subarea-focus"><strong>Foco:</strong> Marca, funil e relacionamento.</div>
            <div class="subarea-mestre"><strong>Mestre:</strong> Estratégias de alto impacto.</div>
          </div>
          <div class="subarea-card">
            <h4>Finanças e Economia Aplicada</h4>
            <div class="subarea-focus"><strong>Foco:</strong> Investimentos, risco, macro/micro.</div>
            <div class="subarea-mestre"><strong>Mestre:</strong> Estratégias robustas de capital.</div>
          </div>
          <div class="subarea-card">
            <h4>Empreendedorismo e Inovação</h4>
            <div class="subarea-focus"><strong>Foco:</strong> Modelos de negócio e liderança.</div>
            <div class="subarea-mestre"><strong>Mestre:</strong> Escala ideias a sucesso.</div>
          </div>
        </div>
      </section>

      <!-- Pessoal -->
      <section class="knowledge-area" aria-labelledby="etica-title">
        <h3 id="etica-title">Ética, Espiritualidade e Desenvolvimento Pessoal</h3>
        <div class="subarea-grid">
          <div class="subarea-card">
            <h4>Ética, Moral e Valores</h4>
            <div class="subarea-focus"><strong>Foco:</strong> Princípios, justiça, integridade.</div>
            <div class="subarea-mestre"><strong>Mestre:</strong> Inspira comportamentos éticos.</div>
          </div>
          <div class="subarea-card">
            <h4>Espiritualidade e Religião</h4>
            <div class="subarea-focus"><strong>Foco:</strong> Práticas de reflexão e meditação.</div>
            <div class="subarea-mestre"><strong>Mestre:</strong> Ajuda na busca de propósito.</div>
          </div>
          <div class="subarea-card">
            <h4>Autoconhecimento e Desenvolvimento</h4>
            <div class="subarea-focus"><strong>Foco:</strong> Metas, IE, mindfulness.</div>
            <div class="subarea-mestre"><strong>Mestre:</strong> Incrementa realização pessoal.</div>
          </div>
        </div>
      </section>

      <!-- Fundamentos -->
      <section class="knowledge-area" aria-labelledby="fund-title">
        <h3 id="fund-title">Habilidades Fundamentais</h3>
        <div class="subarea-grid">
          <div class="subarea-card">
            <h4>Comunicação e Linguagem</h4>
            <div class="subarea-focus"><strong>Foco:</strong> Fala, escrita, escuta ativa.</div>
            <div class="subarea-mestre"><strong>Mestre:</strong> Mensagens claras e persuasivas.</div>
          </div>
          <div class="subarea-card">
            <h4>Resolução de Problemas</h4>
            <div class="subarea-focus"><strong>Foco:</strong> Análise, dados, decisão.</div>
            <div class="subarea-mestre"><strong>Mestre:</strong> Métodos lógicos e criativos.</div>
          </div>
          <div class="subarea-card">
            <h4>Criatividade e Inovação</h4>
            <div class="subarea-focus"><strong>Foco:</strong> Ideias originais e implementação.</div>
            <div class="subarea-mestre"><strong>Mestre:</strong> Influencia setores e mentes.</div>
          </div>
          <div class="subarea-card">
            <h4>Inteligência Emocional</h4>
            <div class="subarea-focus"><strong>Foco:</strong> Autoconsciência e empatia.</div>
            <div class="subarea-mestre"><strong>Mestre:</strong> Conflitos e motivação.</div>
          </div>
          <div class="subarea-card">
            <h4>Liderança e Gestão</h4>
            <div class="subarea-focus"><strong>Foco:</strong> Inspirar, delegar, colaborar.</div>
            <div class="subarea-mestre"><strong>Mestre:</strong> Constrói alto desempenho.</div>
          </div>
          <div class="subarea-card">
            <h4>Organização e Tempo</h4>
            <div class="subarea-focus"><strong>Foco:</strong> Metas, prioridades, processos.</div>
            <div class="subarea-mestre"><strong>Mestre:</strong> Produtividade com equilíbrio.</div>
          </div>
          <div class="subarea-card">
            <h4>Adaptabilidade</h4>
            <div class="subarea-focus"><strong>Foco:</strong> Flexibilidade, aprender sempre.</div>
            <div class="subarea-mestre"><strong>Mestre:</strong> Mantém mentalidade aberta.</div>
          </div>
          <div class="subarea-card">
            <h4>Hard Skills</h4>
            <div class="subarea-focus"><strong>Foco:</strong> Domínio técnico específico.</div>
            <div class="subarea-mestre"><strong>Mestre:</strong> Forma outros profissionais.</div>
          </div>
        </div>
      </section>

      <!-- Placeholders -->
      <section id="progresso" class="sr-only" aria-hidden="true"></section>
      <section id="perfil" class="sr-only" aria-hidden="true"></section>
      <section id="config" class="sr-only" aria-hidden="true"></section>
      <section id="leaderboard" class="sr-only" aria-hidden="true"></section>
      <section id="achievements" class="sr-only" aria-hidden="true"></section>
      <section id="faq" class="sr-only" aria-hidden="true"></section>
      <section id="contato" class="sr-only" aria-hidden="true"></section>

      <!-- Banner "sem resultados" -->
      <div id="noResultsMsg" class="no-results">Nenhuma subárea encontrada para sua busca.</div>
    </main>
  </div>

  <!-- aria-live -->
  <div id="xpLive" class="sr-only" aria-live="polite"></div>
  <div id="searchStatus" class="sr-only" role="status" aria-live="polite"></div>

  <!-- Dialog -->
  <dialog id="levelUpDialog" levelup aria-labelledby="levelUpTitle" aria-describedby="levelUpDesc">
    <div class="trophy" style="font-size:50px; color:var(--color-accent); text-align:center; margin-bottom:10px;" aria-hidden="true">
      <i class="fas fa-trophy"></i>
    </div>
    <h2 id="levelUpTitle" class="dialog-title">Subiu de nível!</h2>
    <p id="levelUpDesc">Parabéns! Você agora é nível <strong id="newLevelValue"></strong>.</p>
    <button class="close-modal-btn hit-target" id="closeModalBtn" type="button" style="background:var(--color-secondary); color:#111; border:0; border-radius:6px; padding:8px 14px; font-weight:700; cursor:pointer;">Fechar</button>
  </dialog>

  <!-- APP -->
  <script nonce="lmup-2025">
(() => {
  if (window.__LMU_APP_INIT__) return;
  window.__LMU_APP_INIT__ = true;

  const LMU_APP_VERSION = '1.0.8';
  window.LMU_APP_VERSION = LMU_APP_VERSION;

  /* Storage */
  const K_LEVEL = 'lmup_level';
  const K_XP    = 'lmup_xp';
  const K_THEME = 'lmup_theme';
  const K_FAVS  = 'lmup_favs_v1';
  const K_FAV_ONLY = 'lmup_fav_only';
  const K_DEV_TOOLS = 'lmup_devtools';
  const K_DEV_XP = 'lmup_dev_xp';

  // helpers primeiro
  const safeGet = (k, fb=null)=>{ try{ const v=localStorage.getItem(k); return v??fb; }catch{ return fb; } };
  const safeSet = (k, v)=>{ try{ localStorage.setItem(k, v); }catch{} };

  // nome + migração (uma única definição)
  const K_NAME  = 'lmup_name';
  (function migrateName(){
    const legacy = safeGet('lmup_name_v1', '');
    if (legacy && !safeGet(K_NAME, '')) safeSet(K_NAME, legacy);
  })();

  /* Seletores */
  const sidebar      = document.getElementById('sidebar');
  const menuToggle   = document.getElementById('menuToggle');
  const overlay      = document.getElementById('overlay');
  const progressBar  = document.getElementById('progressBar');
  const progressText = document.getElementById('progressText');
  const userGreeting = document.getElementById('userGreeting');
  const xpBtn        = document.getElementById('xpBtn');
  const devXpBtn     = document.getElementById('devXpBtn');
  const themeToggle  = document.getElementById('themeToggle');
  const resetBtn     = document.getElementById('resetProgressBtn');
  const levelUpDialog= document.getElementById('levelUpDialog');
  const closeModalBtn= document.getElementById('closeModalBtn');
  const newLevelValue= document.getElementById('newLevelValue');
  const searchStatus = document.getElementById('searchStatus');
  const devXpToggle  = document.getElementById('devXpToggle');

  function getDisplayName(){
    return (safeGet(K_NAME, '') || '').trim();
  }
  function applyDisplayName(){
    const name = getDisplayName();
    userGreeting.textContent = name ? `Olá, ${name}!` : 'Olá, Visitante!';
  }
  applyDisplayName();

  // manter sincronizado se mudar em outra página/aba
  window.addEventListener('storage', (e)=>{
    if (e.key === K_FAV_ONLY) {
      showFavOnly = e.newValue === 'true';
      updateFavBtnUI();
      const q = document.getElementById('siteSearchInput')?.value || '';
      window.applyFilter?.(q);
    }
    if (e.key === K_FAVS) {
      rehydrateFavsFromStorage();
      const q = document.getElementById('siteSearchInput')?.value || '';
      window.applyFilter?.(q);
    }
  });

  // permitir que outras páginas avisem explicitamente
  window.addEventListener('lmu:name-changed', applyDisplayName);

  // expõe uma função global opcional (útil no mini-router)
  window.refreshNameOnTopbar = applyDisplayName;

  // --- favoritos: toggle "apenas favoritos" ---
  const favOnlyBtn = document.getElementById('favOnlyBtn');
  let showFavOnly = safeGet(K_FAV_ONLY, 'false') === 'true';
  updateFavBtnUI();
  function updateFavBtnUI(){
    favOnlyBtn?.setAttribute('aria-pressed', String(showFavOnly));
    const i = favOnlyBtn?.querySelector('i');
    if (i) i.className = showFavOnly ? 'fa-solid fa-star' : 'fa-regular fa-star';
  }

  /* Tema */
  (function bootTheme(){
    if (safeGet(K_THEME, null) === 'dark') document.body.classList.add('dark-mode');
  })();
  function syncThemeColor(){
    const metas = document.querySelectorAll('meta[name="theme-color"]');
    const isDark = document.body.classList.contains('dark-mode');
    const darkColor = getComputedStyle(document.body).getPropertyValue('--color-topbar-bg-dark').trim() || '#0b2533';
    const lightColor = '#0b3042';
    metas.forEach(m => m.setAttribute('content', isDark ? darkColor : lightColor));
  }
  syncThemeColor();
  themeToggle?.addEventListener('click', ()=>{
    document.body.classList.toggle('dark-mode');
    safeSet(K_THEME, document.body.classList.contains('dark-mode')?'dark':'light');
    syncThemeColor();
    window.dispatchEvent(new Event('lmu:theme-changed'));
  });

  /* Progresso */
  const xpNeededForLevel = lvl => Math.max(100, lvl * 100);
  function loadProgress(){
    let level = parseInt(safeGet(K_LEVEL, '1'),10);
    let xp = parseInt(safeGet(K_XP, '0'),10);
    if(Number.isNaN(level)) level = 1;
    if(Number.isNaN(xp)) xp = 0;
    return {level, xp};
  }
  function saveProgress(level, xp){ safeSet(K_LEVEL, String(level)); safeSet(K_XP, String(xp)); }
  function updateProgressUI(level, xp){
    progressText.textContent = `Nível ${level}`;
    const pct = Math.min(100, (xp / xpNeededForLevel(level)) * 100);
    progressBar.style.width = pct + '%';
  }
  let { level, xp } = loadProgress(); updateProgressUI(level, xp);

  /* Dev tools: XP boost */
  let devToolsOn = safeGet(K_DEV_TOOLS, '0') === '1';
  let xpBoostOn = devToolsOn && safeGet(K_DEV_XP, '0') === '1';
  function syncDevXpUI(){
    document.body.classList.toggle('dev-tools', devToolsOn);
    const boostActive = devToolsOn && xpBoostOn;
    if(devXpToggle){
      devXpToggle.hidden = !devToolsOn;
      devXpToggle.setAttribute('aria-pressed', String(boostActive));
      devXpToggle.textContent = boostActive ? 'XP Boost: Ligado' : 'XP Boost: Desligado';
      if(devToolsOn){ devXpToggle.removeAttribute('aria-hidden'); }
      else{ devXpToggle.setAttribute('aria-hidden','true'); }
    }
    if(xpBtn){
      xpBtn.hidden = !boostActive;
      if(boostActive){ xpBtn.removeAttribute('aria-hidden'); }
      else{ xpBtn.setAttribute('aria-hidden','true'); }
    }
  }
  syncDevXpUI();
  if(window?.console?.info){
    console.info('Modo desenvolvedor: use Ctrl+Shift+D (ou ⌘+Shift+D) para alternar a visibilidade do botão de XP.');
  }

  function toggleDevTools(){
    devToolsOn = !devToolsOn;
    safeSet(K_DEV_TOOLS, devToolsOn ? '1' : '0');
    if(!devToolsOn){
      xpBoostOn = false;
      safeSet(K_DEV_XP, '0');
    }
    syncDevXpUI();
  }

  devXpToggle?.addEventListener('click', ()=>{
    if(!devToolsOn) return;
    xpBoostOn = !xpBoostOn;
    safeSet(K_DEV_XP, (xpBoostOn && devToolsOn) ? '1' : '0');
    syncDevXpUI();
  });

  document.addEventListener('keydown', (e)=>{
    if(!(e.key && (e.ctrlKey || e.metaKey) && e.shiftKey)) return;
    if(e.key.toLowerCase() !== 'd') return;
    e.preventDefault();
    toggleDevTools();
  });

  const announce = msg => { if (msg) { document.getElementById('xpLive').textContent = msg; } };

  function openLevelDialog(){
    if(typeof levelUpDialog.showModal === 'function'){
      freezeApp(true); levelUpDialog.showModal(); closeModalBtn.focus();
    }else{
      levelUpDialog.setAttribute('open',''); freezeApp(true); closeModalBtn.focus();
    }
  }
  function closeLevelDialog(){
    levelUpDialog.close?.(); levelUpDialog.removeAttribute('open'); freezeApp(false);
  }

  function applyXpGain(amount){
    if(!Number.isFinite(amount) || amount <= 0) return;
    xp += amount;
    let leveledUp = false;
    let needed = xpNeededForLevel(level);
    while(xp >= needed){
      xp -= needed;
      level += 1;
      leveledUp = true;
      needed = xpNeededForLevel(level);
    }
    saveProgress(level, xp);
    updateProgressUI(level, xp);
    if(leveledUp){
      newLevelValue.textContent = String(level);
      openLevelDialog();
      announce(`Parabéns! Você alcançou o nível ${level}.`);
    }else{
      announce(`Você ganhou ${amount} XP.`);
    }
  }

  xpBtn?.addEventListener('click', ()=> applyXpGain(10));
  devXpBtn?.addEventListener('click', ()=> applyXpGain(10));
  closeModalBtn?.addEventListener('click', closeLevelDialog);

  /* Sidebar / ESC */
  function setSidebar(open){
    menuToggle?.setAttribute('aria-expanded', String(open));
    overlay?.classList.toggle('show', open);
    overlay?.setAttribute('aria-hidden', String(!open));
    document.body.classList.toggle('no-scroll', open);
    if (open) sidebar?.focus(); else menuToggle?.focus();
  }
  menuToggle?.addEventListener('click', ()=>{
    const isOpen = overlay?.classList.contains('show');
    setSidebar(!isOpen);
  });
  overlay?.addEventListener('click', () => setSidebar(false));
  document.addEventListener('keydown', (e)=>{
    if(e.key !== 'Escape') return;
    if(overlay?.classList.contains('show')) setSidebar(false);
    if(levelUpDialog && (levelUpDialog.open || levelUpDialog.hasAttribute('open'))) closeLevelDialog();
  });

  function freezeApp(freeze){
    const canInert = ('inert' in HTMLElement.prototype);
    const siblings = [document.querySelector('header.topbar'), document.getElementById('sidebar'), document.getElementById('mainContent')].filter(Boolean);
    siblings.forEach(el=>{
      if(freeze){
        if(canInert){ el.inert = true; } else { el.setAttribute('data-hidden-while-dialog','true'); el.setAttribute('aria-hidden','true'); }
      }else{
        if(canInert){ el.inert = false; } else { el.removeAttribute('data-hidden-while-dialog'); el.removeAttribute('aria-hidden'); }
      }
    });
  }

  /* Favoritos — chave estável (slug) + migração */
  const favKey = (s='') =>
    s.normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase()
     .replace(/[^\p{L}\p{N}]+/gu,'-').replace(/^-+|-+$/g,'');

  const saveFavs = favSet => { try{ localStorage.setItem(K_FAVS, JSON.stringify([...favSet])); }catch{} };
  const loadFavs = () => {
    try{
      const arr = JSON.parse(localStorage.getItem(K_FAVS)||'[]') || [];
      return new Set(arr.map(favKey)); // migra títulos crus para slug
    }catch{ return new Set(); }
  };
  const favs = loadFavs();

  function rehydrateFavsFromStorage(){
    try{
      const arr = JSON.parse(localStorage.getItem(K_FAVS)||'[]') || [];
      favs.clear(); arr.map(favKey).forEach(v=>favs.add(v));
    }catch{}
  }

  function ensureFavButtons(){
    const cards = document.querySelectorAll('.subarea-card');
    // cria botões se faltarem
    cards.forEach(card=>{
      if(card.querySelector('.fav-btn')) return;
      const title = (card.querySelector('h4')?.textContent || 'Favorito').trim();
      const btn = document.createElement('button');
      btn.className = 'fav-btn hit-target';
      btn.type = 'button';
      btn.setAttribute('aria-label', `Favoritar: ${title}`);
      btn.setAttribute('aria-pressed', 'false');
      btn.innerHTML = '<i class="fa-regular fa-star" aria-hidden="true"></i>';
      card.prepend(btn);
    });
    // aplica estado com base na chave estável
    cards.forEach(card=>{
      const title = (card.querySelector('h4')?.textContent || '').trim();
      const key   = favKey(title);
      card.dataset.favKey = key;
      const btn = card.querySelector('.fav-btn'); if(!btn) return;
      const isFav = favs.has(key);
      btn.classList.toggle('fav-active', isFav);
      btn.setAttribute('aria-pressed', String(isFav));
      const i = btn.querySelector('i'); if(i) i.className = isFav ? 'fa-solid fa-star' : 'fa-regular fa-star';
    });
  }
  ensureFavButtons();

  // Listener único para toggle
  if (!window.__LMU_FAVS_WIRED__) {
    window.__LMU_FAVS_WIRED__ = true;
    document.addEventListener('click', (e)=>{
      const btn = e.target.closest?.('.fav-btn'); if(!btn) return;
      const card = btn.closest('.subarea-card');
      const title = (card.querySelector('h4')?.textContent || '').trim();
      const key   = card?.dataset?.favKey || favKey(title);
      const nowFav = !btn.classList.contains('fav-active');
      btn.classList.toggle('fav-active', nowFav);
      btn.setAttribute('aria-pressed', String(nowFav));
      const i = btn.querySelector('i'); if(i) i.className = nowFav ? 'fa-solid fa-star' : 'fa-regular fa-star';
      if(nowFav) favs.add(key); else favs.delete(key);
      saveFavs(favs);
    });
  }

  /* ======== BUSCA ======== */
  function normalize(text){
    try{ return (text||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase(); }
    catch{ return (text||'').toLowerCase(); }
  }
  function updateSectionVisibility(){
    const areas = document.querySelectorAll('.knowledge-area');
    areas.forEach(area=>{
      const cards = area.querySelectorAll('.subarea-card');
      let anyVisible = false;
      cards.forEach(c=>{ if(!c.hidden) anyVisible = true; });
      area.hidden = !anyVisible;
    });
  }
  function toggleNoResultsBanner(show){
    const el = document.getElementById('noResultsMsg'); if(!el) return;
    el.style.display = show ? 'block' : 'none';
  }
  function reindexCards(){
    const clean = s => normalize(s).replace(/[^\p{L}\p{N}\s]/gu, ' ');
    const list = Array.from(document.querySelectorAll('.subarea-card'));
    list.forEach(card=>{
      const title  = card.querySelector('h4')?.textContent || '';
      const focus  = card.querySelector('.subarea-focus')?.textContent || '';
      const mestre = card.querySelector('.subarea-mestre')?.textContent || '';
      card.dataset.idxTitle = clean(title);
      card.dataset.idxFull  = clean([title, focus, mestre].join(' '));
    });
    return list;
  }
  let CARD_LIST = reindexCards();
  window.applyFilter = function(q=''){
    const nq = normalize(q.trim());
    const terms = nq.split(/\s+/).filter(Boolean);
    let hits = 0;

    if(!nq){
      CARD_LIST.forEach(card=>{ card.hidden = false; card.removeAttribute('aria-hidden'); });
    }else{
      // 1) tenta por TÍTULO (prefixo)
      CARD_LIST.forEach(card=>{
        const tokens = (card.dataset.idxTitle||'').split(/\s+/);
        const titleHit = terms.every(t => tokens.some(tok => tok.startsWith(t)));
        card.hidden = !titleHit;
        card.setAttribute('aria-hidden', String(!titleHit));
      });

      hits = CARD_LIST.reduce((acc,c)=> acc + (c.hidden?0:1), 0);

      // 2) fallback por texto completo (contém)
      if(hits === 0){
        CARD_LIST.forEach(card=>{
          const full = card.dataset.idxFull || '';
          const fullHit = terms.every(t => full.includes(t));
          card.hidden = !fullHit;
          card.setAttribute('aria-hidden', String(!fullHit));
        });
      }
    }

    // 3) aplicar "apenas favoritos" se estiver ativo
    if (showFavOnly) {
      CARD_LIST.forEach(card=>{
        if (card.hidden) return; // já oculto pelo texto
        const title = (card.querySelector('h4')?.textContent || '').trim();
        const key   = card.dataset.favKey || favKey(title);
        const isFav = favs.has(key);
        card.hidden = !isFav;
        card.setAttribute('aria-hidden', String(!isFav));
      });
    }
    hits = CARD_LIST.reduce((acc,c)=> acc + (c.hidden?0:1), 0);
    updateSectionVisibility();
    toggleNoResultsBanner(hits === 0);
    searchStatus.textContent =
      (hits === 0 && (nq || showFavOnly))
        ? `Sem resultados${showFavOnly ? ' nos favoritos' : ''}${nq ? ` para "${q}"` : ''}`
        : `${hits} resultado(s)${showFavOnly ? ' em favoritos' : ''}`;
  };
  function bindSearch(){
    const form = document.getElementById('siteSearchForm');
    const inputEl = document.getElementById('siteSearchInput');
    if(!form || !inputEl) return;

    // evita duplicar listeners
    if (form.__lmu_bound) {
      inputEl.removeEventListener('input', form.__lmu_bound.onType);
      inputEl.removeEventListener('keydown', form.__lmu_bound.onKey);
      form.removeEventListener('submit', form.__lmu_bound.onSubmit);
    }

    // clique do botão "apenas favoritos"
    if (favOnlyBtn && !favOnlyBtn.__lmu_bound) {
      favOnlyBtn.addEventListener('click', ()=>{
        showFavOnly = !showFavOnly;
        safeSet(K_FAV_ONLY, String(showFavOnly)); // <-- persiste o estado
        updateFavBtnUI();
        window.applyFilter(inputEl.value || '');
      });
      favOnlyBtn.__lmu_bound = true;
    }
    updateFavBtnUI();
    window.applyFilter(inputEl.value || '');

    let t = 0;
    const onType = ()=>{ clearTimeout(t); t = setTimeout(()=> window.applyFilter(inputEl.value || ''), 80); };
    const onSubmit = (e)=>{ e.preventDefault(); window.applyFilter(inputEl.value||''); };
    const onKey = (e)=>{ if(e.key==='Enter'){ e.preventDefault(); window.applyFilter(inputEl.value||''); } if(e.key==='Escape'){ inputEl.value=''; window.applyFilter(''); } };

    inputEl.addEventListener('input', onType);
    inputEl.addEventListener('keydown', onKey);
    form.addEventListener('submit', onSubmit);
    form.__lmu_bound = { onType, onKey, onSubmit };
  }
  // inicializa busca
  bindSearch();
  // expõe utilitários pro router
  window.bindSearch = bindSearch;
  window.rehydrateFavsFromStorage = rehydrateFavsFromStorage;
  window.ensureFavButtons = ensureFavButtons;
  window.reindexCards = function(){ CARD_LIST = reindexCards(); return CARD_LIST; };
  window.setSidebar = setSidebar;

  /* Reset */
  resetBtn?.addEventListener('click', ()=>{
    if(!confirm('Resetar nível e XP e recarregar a página?')) return;
    try{
      localStorage.removeItem(K_LEVEL);
      localStorage.removeItem(K_XP);
      alert('Progresso resetado! Recarregando…');
      location.reload();
    }catch(e){
      alert('Não consegui limpar. Veja o console.'); console.error(e);
    }
  });

  /* NAV: evitar rolagem para placeholders */
  document.addEventListener('click', (e)=>{
    const link = e.target.closest && e.target.closest('a[href^="#"]');
    if(!link) return;
    const hash = link.getAttribute('href'); if(!hash || hash === '#') return;

    const id = hash.slice(1);
    const target = document.getElementById(id); if(!target) return;

    e.preventDefault();
    setSidebar(false);

    if(target.classList.contains('sr-only')){
      announce('Seção em construção. Redirecionando para Áreas do Conhecimento.');
      document.getElementById('areas')?.scrollIntoView({behavior:'smooth', block:'start'});
      return;
    }
    target.scrollIntoView({behavior:'smooth', block:'start'});
  });

  /* SW */
  if('serviceWorker' in navigator){
    navigator.serviceWorker.register('sw.js').catch(()=>{});
  }
})();
  </script>

  <!-- Mini-router -->
  <script nonce="lmup-2025">
(() => {
  if (window.__LMU_ROUTER_INIT__) return;
  window.__LMU_ROUTER_INIT__ = true;

  function isInternalHTMLLink(a){
    try{
      const u = new URL(a.href, location.href);
      return u.origin === location.origin && /\.html$/i.test(u.pathname);
    }catch{ return false; }
  }

  function injectPageAssets(doc){
    // limpa injeções anteriores
    document.head.querySelectorAll('[data-router-style]').forEach(el => el.remove());
    document.body.querySelectorAll('script[data-router-script]').forEach(el => el.remove());
    document.body.querySelectorAll('[data-router-extra]').forEach(el => el.remove());

    // injeta <style> e CSS externos da página
    doc.querySelectorAll('style, link[rel="stylesheet"]').forEach(node=>{
      const clone = node.cloneNode(true);
      clone.setAttribute('data-router-style','');
      if (clone.tagName === 'LINK' && clone.href) {
        if ([...document.head.querySelectorAll('link[rel="stylesheet"]')].some(l => l.href === clone.href)) return;
      }
      document.head.appendChild(clone);
    });

    // importa <dialog> (ex.: da página de progresso)
    doc.querySelectorAll('dialog').forEach(dlg => {
      const clone = dlg.cloneNode(true);
      clone.setAttribute('data-router-extra','');
      document.body.appendChild(clone);
    });
  }

  function restoreUIAfterNav(){
    try{ window.rehydrateFavsFromStorage?.(); }catch{}
    try{ window.ensureFavButtons?.(); }catch{}
    try{ window.reindexCards?.(); }catch{}
    try{ window.bindSearch?.(); }catch{}
    try{
      const q = document.getElementById('siteSearchInput')?.value || '';
      window.applyFilter?.(q);
    }catch{}
  }

  async function navigateTo(url, replace){
    const live = document.getElementById('xpLive');
    if(live) live.textContent = 'Carregando conteúdo…';
    try{
      const bust = (window.LMU_APP_VERSION || 'dev') + '-' + Date.now();
      const vUrl = url + (url.includes('?') ? '&' : '?') + 'v=' + bust;
      const res  = await fetch(vUrl, { headers: { 'X-LMU-Partial': '1' }, cache: 'no-store' });
      const text = await res.text();
      const doc  = new DOMParser().parseFromString(text, 'text/html');
      const newMain = doc.querySelector('main');
      if(!newMain){ location.href = url; return; }

      injectPageAssets(doc);

      newMain.id = 'mainContent';
      const curMain = document.getElementById('mainContent');
      curMain.replaceWith(newMain);

      restoreUIAfterNav();
      requestAnimationFrame(restoreUIAfterNav);

      // injeta apenas scripts marcados como de página
      window.__LMU_PARTIAL__ = true;
      doc.querySelectorAll('script[data-page-script]').forEach(s=>{
        const ns = document.createElement('script');
        ns.setAttribute('nonce','lmup-2025');
        if (s.src) ns.src = s.src; else ns.textContent = s.textContent;
        ns.setAttribute('data-router-script','');
        ns.setAttribute('data-page-script','');
        document.body.appendChild(ns);
      });
      setTimeout(()=>{ try{ delete window.__LMU_PARTIAL__; }catch{} }, 0);

      document.title = doc.title || document.title;
      if(!replace) history.pushState({partial:true, url}, '', url);

      newMain.setAttribute('tabindex','-1');
      newMain.focus({ preventScroll:false });

      if (typeof window.setSidebar === 'function') window.setSidebar(false);
      if (live) live.textContent = 'Conteúdo carregado.';

      if (typeof window.initPageController === 'function') {
        window.initPageController(url);
      }
      if (/progresso\.html(?:$|[?#])/.test(url) && typeof window.initProgressPage === 'function') {
        window.initProgressPage();
      }
      if (/perfil\.html(?:$|[?#])/.test(url) && typeof window.initPerfilPage === 'function') {
        window.initPerfilPage();
      }
    }catch{
      location.href = url;
    }
  }

  document.addEventListener('click', (e)=>{
    const a = e.target.closest && e.target.closest('a[href]');
    if(!a) return;
    if(isInternalHTMLLink(a)){ e.preventDefault(); navigateTo(a.href, false); }
  });

  window.addEventListener('popstate', (e) => {
    if (e.state && e.state.partial) {
      navigateTo(location.href, true).then(restoreUIAfterNav);
    }
  });

  // retorno do progresso aberto direto (MPA -> SPA)
  const goto = sessionStorage.getItem('lmu_goto');
  if (goto) {
    sessionStorage.removeItem('lmu_goto');
    navigateTo(goto, false);
  }

  // snapshot de subáreas para o datalist do progresso
  window.LMU_SUBAREAS = Array.from(document.querySelectorAll('.subarea-card h4'))
    .map(h => h.textContent.trim())
    .filter(Boolean);
})();
  </script>
</body>
</html>
